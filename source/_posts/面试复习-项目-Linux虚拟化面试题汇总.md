---
title: 面试复习-项目-Linux虚拟化面试题汇总
date: 2024-09-04 19:29:51
tags: [linux, kvm, virtio, qemu]
published: false
hideInList: true
feature: 
isTop: false
categories: 计算机基础
---

### CPU虚拟化是怎么实现的？

硬件辅助虚拟化的情况下，CPU提供了根模式和非根模式，VMM 运行在根模式下，拥有最高的特权级别，可以直接访问物理硬件资源。Guest OS 运行在非根模式（VMX）下，当它执行敏感指令时，处理器会自动切换到根模式，由 VMM 进行处理。

<img src="/images/vcpu.png" width="500px" />

QEMU会为每个vcpu创建一个线程，这个线程会通过ioctl给KVM发送`KVM_RUN`指令让CPU进入VMX模式并切换成VM的上下文。

VMCB(VM控制块)可以被两种模式(root, vmx)访问，所以可以用来存储：

- HOST CPU上下文
- Guest CPU上下文
- Guest Entry/EXECUTION/EXIT 控制区，KVM可以配置哪些指令和异常能导致VM exit.
- Exit information: VM exit的原因

### 内存虚拟化是怎么实现的？

虚拟机在创建时QEMU会给每个虚拟机分配一块内存(mmap), 虚拟机的物理地址空间其实就是这块内存在QEMU中的虚拟地址空间，EPT扩展页维护了虚拟机虚拟地址到主机物理地址空间的映射，从而使虚拟机可以访问主机的内存。

- 虚拟机启动时，KVM 和 QEMU 协同工作，为虚拟机分配物理内存，并创建相应的页表结构。
- 当虚拟机中的应用程序访问内存时，KVM 会通过硬件辅助虚拟化技术将客户机虚拟地址转换为物理地址。
- QEMU 负责模拟硬件设备，并将对虚拟设备的内存访问转换为对物理内存的访问。
- 如果虚拟机需要更多内存，KVM 和 QEMU 会共同进行内存分配和管理，确保虚拟机有足够的内存可用。
- QEMU 还可以对内存进行优化和共享，以提高性能和减少内存使用量。


### 中断的处理
- 设备生成中断不考虑时钟同步，直接发送给中断控制器和CPU。异常的处理与中断类似，但考虑时钟同步，被称为同步中断
- CPU收到中断后，内核会调用`do_IRQ()`
- do_IRQ会获取中断号、保存被中断进程的上下文
- do_IRQ根据中断号获取对应的中断处理程序
- 当中断处理程序结束后do_IRQ会将保存在内核栈中的进程上下文恢复
- 将程序计数器的值恢复为被中断进程的下一条指令

- 中断上下文不可以睡眠，中断处理程序并不具有自己的栈，它会共享被中断进程的内核栈
- 中断处理程序分为上下两部分，上半部通常只执行有严格时限的工作，如中断应答、复位硬件、从网卡缓冲区把数据拷贝到内存等。下半部执行比较耗时的工作。


### 多线程访问一块内存的时候，怎么样优化其性能

### 介绍一下Virtio

### 介绍一下NUMA

### Kubevirt是怎么实现虚拟机管理的

### Linux的进程是怎么调度的

### 如果虚拟机出现了故障，可以用哪些Linux命令去解决

### 虚拟机初始化的时候是怎么从Openstack拿到ssh key的

### C语言中静态变量与全局变量有什么区别

### Linux进程与线程有什么区别

### Linux线程共享了进程的什么内容

### TCP的连接是怎么建立的

TCP段中的标志位有：
- SYN: 同步标志，用于建立连接
- ACK: 确认标志，表示确认收到请求
- RST: 复位标志，用于复位相应的 TCP 连接
- PSH: 推标志，用于请求立即将数据交付给接收方的应用程序，而不是在缓冲区中等待
- FIN: 结束标志，用于请求关闭连接
- URG: 紧急标志，用于指示数据包中的数据应被优先处理。

TCP建立连接的步骤如下：
- 客户端发送一个标志位SYN为1、序列号为随机数x的数据段给服务器端，并进入SYNC-SENT状态
- 服务器端回复一个ACK标志位为1、SYN标志位为1、顺序号为`x+1`、应答号为随机数y的数据段表示接受连接，并进入SYNC-RCVD状态
- 客户端再发送给服务器端一个ACK标志位为1、顺序号为`x+1`、应答号为`y+1`的数据段，并进入ESTABLISHED状态
- 服务器端收到上述数据段后进入ESTABLISHED状态

TCP关闭连接的步骤如下：
- 客户端发送一个标志位FIN为1的数据段，并进入`FIN_WAIT_1`状态
- 服务器端收到后会发送个客户端一个ACK为1的数据段并进入`CLOSE_WAIT`状态
- 服务器端发送一个FIN 和 ACK 标志位都被设置为 1的数据段，进入`LAST_ACK`状态
- 客户端发送一个ACK为1的报文给服务器端，进入`TIME_WAIT`状态，服务器收到后进入`CLOSED`状态
- 客户端等待`2*MSL`的时间后进入`CLOSED`状态

TCP 关闭连接时客户端在`TIME_WAIT`状态下会等待 2 倍的最大报文段生存时间（2MSL），主要原因如下：

- 确保 ACK 被接收
当客户端发送最后一个 ACK 确认报文段以响应服务器的 FIN 报文段后，这个 ACK 报文段可能在传输过程中丢失。如果丢失，服务器将重新发送 FIN 报文段。
客户端在 TIME - WAIT 状态等待 2MSL 时间，能够确保它有足够的时间收到服务器重传的 FIN 报文段，并再次发送 ACK 确认报文段。

- 使旧连接的报文段在网络中消失
TCP 连接使用 IP 地址和端口号来标识。在网络环境中，可能存在报文段由于网络延迟等原因而延迟到达的情况。
当一个新的连接建立时，如果之前旧连接的报文段仍在网络中传播，可能会干扰新连接。等待 2MSL 时间可以保证本次连接中产生的所有报文段都从网络中消失，从而避免旧的连接报文段对下一个 TCP 连接造成干扰。

### 当前项目代码行数大概多少

... ...


