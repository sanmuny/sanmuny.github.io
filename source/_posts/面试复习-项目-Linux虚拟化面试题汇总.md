---
title: 面试复习-项目-Linux虚拟化面试题汇总
date: 2024-09-04 19:29:51
tags: [linux, kvm, virtio, qemu]
published: false
hideInList: true
feature: 
isTop: false
categories: 计算机基础
tags:
categories:
---

### CPU虚拟化是怎么实现的？

硬件辅助虚拟化的情况下，CPU提供了根模式和非根模式，VMM 运行在根模式下，拥有最高的特权级别，可以直接访问物理硬件资源。Guest OS 运行在非根模式（VMX）下，当它执行敏感指令时，处理器会自动切换到根模式，由 VMM 进行处理。

<img src="/images/vcpu.png" width="500px" />

QEMU会为每个vcpu创建一个线程，这个线程会通过ioctl给KVM发送`KVM_RUN`指令让CPU进入VMX模式并切换成VM的上下文。

VMCB(VM控制块)可以被两种模式(root, vmx)访问，所以可以用来存储：

- HOST CPU上下文
- Guest CPU上下文
- Guest Entry/EXECUTION/EXIT 控制区，KVM可以配置哪些指令和异常能导致VM exit.
- Exit information: VM exit的原因

### 内存虚拟化是怎么实现的？

虚拟机在创建时QEMU会给每个虚拟机分配一块内存(mmap), 虚拟机的物理地址空间其实就是这块内存在QEMU中的虚拟地址空间，EPT扩展页维护了虚拟机虚拟地址到主机物理地址空间的映射，从而使虚拟机可以访问主机的内存。

- 虚拟机启动时，KVM 和 QEMU 协同工作，为虚拟机分配物理内存，并创建相应的页表结构。
- 当虚拟机中的应用程序访问内存时，KVM 会通过硬件辅助虚拟化技术将客户机虚拟地址转换为物理地址。
- QEMU 负责模拟硬件设备，并将对虚拟设备的内存访问转换为对物理内存的访问。
- 如果虚拟机需要更多内存，KVM 和 QEMU 会共同进行内存分配和管理，确保虚拟机有足够的内存可用。
- QEMU 还可以对内存进行优化和共享，以提高性能和减少内存使用量。


### 中断的处理
- 设备生成中断不考虑时钟同步，直接发送给中断控制器和CPU。异常的处理与中断类似，但考虑时钟同步，被称为同步中断
- CPU收到中断后，内核会调用`do_IRQ()`
- do_IRQ会获取中断号、保存被中断进程的上下文
- do_IRQ根据中断号获取对应的中断处理程序
- 当中断处理程序结束后do_IRQ会将保存在内核栈中的进程上下文恢复
- 将程序计数器的值恢复为被中断进程的下一条指令

- 中断上下文不可以睡眠，中断处理程序并不具有自己的栈，它会共享被中断进程的内核栈
- 中断处理程序分为上下两部分，上半部通常只执行有严格时限的工作，如中断应答、复位硬件、从网卡缓冲区把数据拷贝到内存等。下半部执行比较耗时的工作。


### 多线程访问一块内存的时候，怎么样优化其性能

### 介绍一下Virtio

### 介绍一下NUMA

### Kubevirt是怎么实现虚拟机管理的

### Linux的进程是怎么调度的

### 如果虚拟机出现了故障，可以用哪些Linux命令去解决

### 虚拟机初始化的时候是怎么从Openstack拿到ssh key的


