---
title: 面试复习-项目-Linux虚拟化面试题汇总
date: 2024-09-04 19:29:51
tags: [linux, kvm, virtio, qemu]
published: false
hideInList: true
feature: 
isTop: false
categories: 计算机基础
---

### CPU虚拟化是怎么实现的？

硬件辅助虚拟化的情况下，CPU提供了根模式和非根模式，VMM 运行在根模式下，拥有最高的特权级别，可以直接访问物理硬件资源。Guest OS 运行在非根模式（VMX）下，当它执行敏感指令时，处理器会自动切换到根模式，由 VMM 进行处理。

<img src="/images/vcpu.png" width="500px" />

QEMU会为每个vcpu创建一个线程，这个线程会通过ioctl给KVM发送`KVM_RUN`指令让CPU进入VMX模式并切换成VM的上下文。

VMCB(VM控制块)可以被两种模式(root, vmx)访问，所以可以用来存储：

- HOST CPU上下文
- Guest CPU上下文
- Guest Entry/EXECUTION/EXIT 控制区，KVM可以配置哪些指令和异常能导致VM exit.
- Exit information: VM exit的原因

### 内存虚拟化是怎么实现的？

虚拟机在创建时QEMU会给每个虚拟机分配一块内存(mmap), 虚拟机的物理地址空间其实就是这块内存在QEMU中的虚拟地址空间，EPT扩展页维护了虚拟机物理地址到主机物理地址空间的映射，从而使虚拟机可以访问主机的内存。

- 虚拟机启动时，KVM 和 QEMU 协同工作，为虚拟机分配物理内存，并创建相应的页表结构。
- 当虚拟机中的应用程序访问内存时，KVM 会通过硬件辅助虚拟化技术将客户机虚拟地址转换为物理地址。
- QEMU 负责模拟硬件设备，并将对虚拟设备的内存访问转换为对物理内存的访问。
- 如果虚拟机需要更多内存，KVM 和 QEMU 会共同进行内存分配和管理，确保虚拟机有足够的内存可用。
- QEMU 还可以对内存进行优化和共享，以提高性能和减少内存使用量。


### 中断的处理
- 设备生成中断不考虑时钟同步，直接发送给中断控制器和CPU。异常的处理与中断类似，但考虑时钟同步，被称为同步中断
- CPU收到中断后，内核会调用`do_IRQ()`
- do_IRQ会获取中断号、保存被中断进程的上下文
- do_IRQ根据中断号获取对应的中断处理程序
- 当中断处理程序结束后do_IRQ会将保存在内核栈中的进程上下文恢复
- 将程序计数器的值恢复为被中断进程的下一条指令

- 中断上下文不可以睡眠，中断处理程序并不具有自己的栈，它会共享被中断进程的内核栈
- 中断处理程序分为上下两部分，上半部通常只执行有严格时限的工作，如中断应答、复位硬件、从网卡缓冲区把数据拷贝到内存等。下半部执行比较耗时的工作。

下半部执行的三种方式：

- 软中断：需要编译的时候就注册软中断，中断处理程序执行完硬件设备相关的操作后就会调用do_softirq()函数执行被raise_softirq(SOFTIRQ_TYPE)挂起的软中断。
- tasklet: tasklet其实是用软中断实现的(Hi_SOFTIRQ及TASKLET_IRQ)。它允许驱动程序动态的注册


### 多线程访问一块内存的时候，怎么样优化其性能

### 介绍一下Virtio

### 介绍一下NUMA

### Kubevirt是怎么实现虚拟机管理的

### Linux的进程是怎么调度的

### 如果虚拟机出现了故障，可以用哪些Linux命令去解决

### 虚拟机初始化的时候是怎么从Openstack拿到ssh key的

### C语言中静态变量与全局变量有什么区别

### Linux进程与线程有什么区别

### Linux线程共享了进程的什么内容

### TCP的连接是怎么建立的

TCP段中的标志位有：
- SYN: 同步标志，用于建立连接
- ACK: 确认标志，表示确认收到请求
- RST: 复位标志，用于复位相应的 TCP 连接
- PSH: 推标志，用于请求立即将数据交付给接收方的应用程序，而不是在缓冲区中等待
- FIN: 结束标志，用于请求关闭连接
- URG: 紧急标志，用于指示数据包中的数据应被优先处理。

TCP建立连接的步骤如下：
- 客户端发送一个标志位SYN为1、序列号为随机数x的数据段给服务器端，并进入SYNC-SENT状态
- 服务器端回复一个ACK标志位为1、SYN标志位为1、顺序号为`x+1`、应答号为随机数y的数据段表示接受连接，并进入SYNC-RCVD状态
- 客户端再发送给服务器端一个ACK标志位为1、顺序号为`x+1`、应答号为`y+1`的数据段，并进入ESTABLISHED状态
- 服务器端收到上述数据段后进入ESTABLISHED状态

TCP关闭连接的步骤如下：
- 客户端发送一个标志位FIN为1的数据段，并进入`FIN_WAIT_1`状态
- 服务器端收到后会发送个客户端一个ACK为1的数据段并进入`CLOSE_WAIT`状态
- 服务器端发送一个FIN 和 ACK 标志位都被设置为 1的数据段，进入`LAST_ACK`状态
- 客户端发送一个ACK为1的报文给服务器端，进入`TIME_WAIT`状态，服务器收到后进入`CLOSED`状态
- 客户端等待`2*MSL`的时间后进入`CLOSED`状态

TCP 关闭连接时客户端在`TIME_WAIT`状态下会等待 2 倍的最大报文段生存时间（2MSL），主要原因如下：

- 确保 ACK 被接收
当客户端发送最后一个 ACK 确认报文段以响应服务器的 FIN 报文段后，这个 ACK 报文段可能在传输过程中丢失。如果丢失，服务器将重新发送 FIN 报文段。
客户端在 TIME - WAIT 状态等待 2MSL 时间，能够确保它有足够的时间收到服务器重传的 FIN 报文段，并再次发送 ACK 确认报文段。

- 使旧连接的报文段在网络中消失
TCP 连接使用 IP 地址和端口号来标识。在网络环境中，可能存在报文段由于网络延迟等原因而延迟到达的情况。
当一个新的连接建立时，如果之前旧连接的报文段仍在网络中传播，可能会干扰新连接。等待 2MSL 时间可以保证本次连接中产生的所有报文段都从网络中消失，从而避免旧的连接报文段对下一个 TCP 连接造成干扰。

### 如何设计一个软件

1. Linux系统的设计理念"Do one thing, and do it well"，每个Linux命令都只做很小的功能，但通过Shell的组合可以实现更为复杂的功能。这点和函数式编程的风格也比较类似。所以在做架构设计的时候尽量让模块功能明确，可以提高可重用性以及快速的定位和分析问题。

2. 在交互设计的时候尽量遵循现有的一些规范，如RESTful API。接口的设计需要明确，尽量不要有重复的、叠加的功能。

3. 在数据存储方面，尽量避免多个组件共同直接操作数据库，需要设计一个单独的组件来负责数据的处理。

4. 为提升性能，可以考虑设计与实现缓存系统。

5. 需要设计和实现日志系统，尽量让日志信息详细、准确以便快速定位和分析问题。

### 设计一个高性能的存储系统

1. 可以实现一个缓存

2. 设备虚拟化可以从半虚拟化下移到硬件辅助虚拟化以提升性能

3. 使用异步I/O或者I/O多路复用可以批量处理数据以提升性能

4. 可以通过写时复用等技术延后处理极有可能不用处理的数据

5. 后台线程如清理程序的设计可以给上层提供较全面的接口，以便上层组件可以根据实际的业务需求去更改配置进行性能优化

### 重构的时机，重构的代码如何保证，如何和设计模式结合

1. 代码的可扩展性及可重用性太差，实现新功能的代价远大于重构的代价的时候应该进行重构。拿我所做的IaaS镜像自动化的项目举例来说，原先的设计是
每个操作系统类型、版本都对应了一套构建脚本以及Devops pipeline，然而，随着支持的操作系统越来越多，版本越来越多，支持新的操作系统或者版本
的代价将会变的很大。这个时候就需要进行重构，让多个操作系统、多个版本的构建脚本统一起来。

2. 重构软件时，可以利用不同技术的脚手架工具，让项目的内容尽可能的完整。如python或者js的脚手架工具会帮我们生成完整的目录结构。如文档、代码、单元测试、
集成测试、E2E测试、脚本工具等。

3. 重构的代码应该有完善的Devops管理机制。如CI的时候，需要不同的开发人员来评审代码，PR中的新代码单元测试的代码覆盖率达到80%等。部署的时候需要
对不同的环境的权限进行严格的管理，如开发环境、staging、产品环境。

4. 设计模块的功能尽量明确和单一，可以保证代码的可重用性，也可以能够尽快的分析出问题。另外可以实现抽象层，抽象层只需要定义一些接口，而具体的
功能可以用过下层的驱动或者适配层来完成。


### 已知有快照等特性，设计存储系统容灾架构、及关键组件

1. 数据采集器：负责从混合云或者其他的数据中心接收或者采集所需要备份的数据和元数据

2. IAM: 负责身份认证、秘钥管理和权限管理等内容

3. 元数据管理器：负责将其他组件生成的元数据保存到系统数据库中

4. 数据管理器：负责数据的校验、去重等功能，并调用元数据管理器将元数据写入数据库

5. 消息队列：负责各个组件的通信

6. 后端存储器：将数据落地到跨AZ或者地区的分布式的存储系统

7. API服务器：提供对外的RESTful API访问

8. SDK, CMD tool, library, UI

9. API的分类可以有：数据源的管理，定时策略，备份区域管理，数据备份策略，数据的读写等功能，秘钥管理



### 当前项目代码行数大概多少

... ...
