<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ansible概要 | 三木的技术博客</title><meta name="keywords" content="Ansible"><meta name="author" content="三木"><meta name="copyright" content="三木"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ansible是什么？Ansible是一个自动化管理远程系统的工具，它主要有两个功能：  自动化管理远程节点 控制远程节点，让它们满足预期的状态  主要由3个组件构成：  控制节点： 用于安装和运行ansible。 被控制节点： ansible管理的节点。 清单(Inventory)：按逻辑组织的被控制节点列表，它描述了ansible管理的对象。    Ansible的安装配置步骤：  使用Hom">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible概要">
<meta property="og:url" content="https://wangsen.site/2022/11/09/Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="三木的技术博客">
<meta property="og:description" content="Ansible是什么？Ansible是一个自动化管理远程系统的工具，它主要有两个功能：  自动化管理远程节点 控制远程节点，让它们满足预期的状态  主要由3个组件构成：  控制节点： 用于安装和运行ansible。 被控制节点： ansible管理的节点。 清单(Inventory)：按逻辑组织的被控制节点列表，它描述了ansible管理的对象。    Ansible的安装配置步骤：  使用Hom">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wangsen.site/images/ansible.png">
<meta property="article:published_time" content="2022-11-09T13:45:08.000Z">
<meta property="article:modified_time" content="2025-03-14T14:36:52.628Z">
<meta property="article:author" content="三木">
<meta property="article:tag" content="Ansible">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wangsen.site/images/ansible.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://wangsen.site/2022/11/09/Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ansible概要',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-14 22:36:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">134</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">80</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-tie"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">三木的技术博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-tie"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Ansible概要</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-09T13:45:08.000Z" title="发表于 2022-11-09 21:45:08">2022-11-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-14T14:36:52.628Z" title="更新于 2025-03-14 22:36:52">2025-03-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>52分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ansible概要"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/11/09/Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2022/11/09/Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span></a></span></div></div></div><article class="post-content" id="article-container"><h3 id="Ansible是什么？"><a href="#Ansible是什么？" class="headerlink" title="Ansible是什么？"></a>Ansible是什么？</h3><p>Ansible是一个自动化管理远程系统的工具，它主要有两个功能：</p>
<ul>
<li>自动化管理远程节点</li>
<li>控制远程节点，让它们满足预期的状态</li>
</ul>
<p>主要由3个组件构成：</p>
<ol>
<li>控制节点： 用于安装和运行ansible。</li>
<li>被控制节点： ansible管理的节点。</li>
<li>清单(Inventory)：按逻辑组织的被控制节点列表，它描述了ansible管理的对象。</li>
</ol>
<img src=/images/ansible-overview.png width=400/>

<p>Ansible的安装配置步骤：</p>
<ol>
<li><p>使用Homebrew安装: <code>brew install ansible</code></p>
</li>
<li><p>创建被管理节点的清单hosts.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">master:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">master-node:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">52.118</span><span class="number">.108</span><span class="number">.104</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">node-1:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">150.238</span><span class="number">.65</span><span class="number">.205</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure></li>
<li><p>检验清单是否正确。-i用于指定清单文件，all和master是被管理节点的模式(pattern)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i hosts.yaml all --list-host</span><br><span class="line">  hosts (2):</span><br><span class="line">    master-node</span><br><span class="line">    node-1</span><br><span class="line">$ ansible -i hosts.yaml master --list-host</span><br><span class="line">  hosts (1):</span><br><span class="line">    master-node</span><br></pre></td></tr></table></figure></li>
<li><p>配置SSH免密码登录，让控制节点可以远程连接到被管理节点。</p>
</li>
<li><p>检验SSH是否配置正确</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ansible</span> -i hosts.yaml all -m ping</span><br><span class="line">master-node | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">node-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="如何写一个Ansible清单"><a href="#如何写一个Ansible清单" class="headerlink" title="如何写一个Ansible清单?"></a>如何写一个Ansible清单?</h3><ul>
<li>Inventory支持多种文件格式，最常用的两种是INI和YAML。</li>
<li>可以对清单中的节点分组(group)，系统有两个默认分组 <code>all</code>和<code>ungrouped</code>。</li>
<li>可以使用children来嵌套分组。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">master:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">master-node:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">52.118</span><span class="number">.108</span><span class="number">.104</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">node-1:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">150.238</span><span class="number">.65</span><span class="number">.205</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">prod:</span></span><br><span class="line">      <span class="attr">children:</span></span><br><span class="line">        <span class="attr">master:</span></span><br><span class="line">        <span class="attr">nodes:</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i hosts.yaml prod --list-hosts</span><br><span class="line">  hosts (2):</span><br><span class="line">    master-node</span><br><span class="line">    node-1</span><br></pre></td></tr></table></figure></li>
<li>可以使用类似于python切片的语法来指定被控制节点的范围<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pod1:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="number">9.1</span><span class="number">.1</span><span class="string">.[1:10:2]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i range.yaml pod1 --list-hosts</span><br><span class="line">  hosts (5):</span><br><span class="line">    9.1.1.1</span><br><span class="line">    9.1.1.3</span><br><span class="line">    9.1.1.5</span><br><span class="line">    9.1.1.7</span><br><span class="line">    9.1.1.9</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="如何使用变量？"><a href="#如何使用变量？" class="headerlink" title="如何使用变量？"></a>如何使用变量？</h3><ul>
<li>变量名和python的命名规则相同，由字母数字下划线组成且不能以数字开头，不能是python或者ansible的关键字。</li>
<li>使用yaml风格定义变量</li>
<li>变量作用范围为global,play,host</li>
<li>可以在task中使用register将输出赋值给变量</li>
</ul>
<h3 id="如何在清单中添加变量？"><a href="#如何在清单中添加变量？" class="headerlink" title="如何在清单中添加变量？"></a>如何在清单中添加变量？</h3><ol>
<li>给一个节点添加变量，可以直接在节点下添加键值对，如上述hosts.yaml中的<code>ansible_host</code>和<code>ansible_user</code>。</li>
<li>给一个group添加变量，可以在group下面添加vars字段。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">master:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">master-node:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">52.118</span><span class="number">.108</span><span class="number">.104</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">node-1:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">150.238</span><span class="number">.65</span><span class="number">.205</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ntp_server:</span> <span class="number">9.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">prod:</span></span><br><span class="line">      <span class="attr">children:</span></span><br><span class="line">        <span class="attr">master:</span></span><br><span class="line">        <span class="attr">nodes:</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i hosts.yaml master -a <span class="string">&quot;echo &#123;&#123; ntp_server &#125;&#125;&quot;</span></span><br><span class="line">master-node | FAILED | rc=-1 &gt;&gt;</span><br><span class="line">The task includes an option with an undefined variable. The error was: <span class="string">&#x27;ntp_server&#x27;</span> is undefined. <span class="string">&#x27;ntp_server&#x27;</span> is undefined</span><br><span class="line">$ ansible -i hosts.yaml nodes -a <span class="string">&quot;echo &#123;&#123; ntp_server &#125;&#125;&quot;</span></span><br><span class="line">node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">9.1.1.1</span><br></pre></td></tr></table></figure></li>
<li>也可以在清单文件同目录下创建<code>group_vars/&#123;&#123;group_name&#125;&#125;</code>文件来给group定义变量。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat group_vars/master</span><br><span class="line">---</span><br><span class="line">ftp_server: 9.1.1.1</span><br><span class="line">$ ansible -i hosts.yaml master -a <span class="string">&quot;echo &#123;&#123; ftp_server &#125;&#125;&quot;</span></span><br><span class="line">master-node | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">9.1.1.1</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="如何使用模式来匹配目标主机？"><a href="#如何使用模式来匹配目标主机？" class="headerlink" title="如何使用模式来匹配目标主机？"></a>如何使用模式来匹配目标主机？</h3><p>模式(Pattern)可以通过通配符或者正则表达式来指定一个主机、IP、或者清单组(group)。</p>
<ul>
<li><code>all</code>或者<code>*</code>匹配所有主机</li>
<li>主机或者group名匹配一个主机或者一个group</li>
<li>可以用<code>:</code>或者<code>,</code>指定多个主机或group</li>
<li><code>group1:!group2</code> 匹配在group1中且不在group2中的主机</li>
<li><code>group1:&amp;group2</code> 匹配既在group1又在group2中的主机</li>
</ul>
<h3 id="如何如何执行临时命令？"><a href="#如何如何执行临时命令？" class="headerlink" title="如何如何执行临时命令？"></a>如何如何执行临时命令？</h3><p>可以使用下面的命令来执行临时命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible [pattern] -m [module] -a <span class="string">&quot;[module options]&quot;</span></span><br></pre></td></tr></table></figure>
<p>如果不指定<code>-m [module]</code>，ansible会使用默认的<code>command</code>模块，module options就是要执行的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i hosts.yaml master -a <span class="string">&#x27;ls $HOME&#x27;</span></span><br><span class="line">master-node | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">snap</span><br></pre></td></tr></table></figure>
<p>使用<code>file</code>模块来创建一个目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i hosts.yaml master -m ansible.builtin.file -a <span class="string">&quot;dest=/root/projects mode=755 owner=root group=root state=directory&quot;</span></span><br><span class="line">master-node | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0755&quot;</span>,</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/root/projects&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 4096,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;directory&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">$ ansible -i hosts.yaml master -a <span class="string">&#x27;ls $HOME&#x27;</span> -u root</span><br><span class="line">master-node | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">projects</span><br><span class="line">snap</span><br></pre></td></tr></table></figure>

<h3 id="jinja2是什么？"><a href="#jinja2是什么？" class="headerlink" title="jinja2是什么？"></a>jinja2是什么？</h3><p><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/3.1.x/templates/#synopsis">jinja2</a>是一种模板语言，通常用于web后端渲染HTML页面，但它可以处理所有格式的文本文件。</p>
<p>Template + data = HTML</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>My Webpage<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;navigation&quot;</span>&gt;</span></span><br><span class="line">    &#123;% for item in navigation %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; item.href &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; item.caption &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>My Webpage<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;&#123; a_variable &#125;&#125;</span><br><span class="line"></span><br><span class="line">    &#123;# a comment #&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>jinja的三种语句：</p>
<ul>
<li><code>&#123;% ... %&#125;</code> for Statements</li>
<li><code>&#123;&#123; ... &#125;&#125;</code> for Expressions to print to the template output</li>
<li><code>&#123;# ... #&#125;</code> for Comments not included in the template output</li>
</ul>
<p>jinja的过滤器filters:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; name|<span class="name">striptags</span>|<span class="name">title</span> &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>过滤器相当于一个把变量name当做参数的纯函数组合，上述过滤器就相当于函数调用<code>title(striptags(name))</code>。</p>
<h3 id="Ansible-playbooks是什么？"><a href="#Ansible-playbooks是什么？" class="headerlink" title="Ansible playbooks是什么？"></a>Ansible playbooks是什么？</h3><p>前面介绍的临时命令并不能满足复杂的部署任务，利用可重复使用、配置简单的ansible playbook就可以实现复杂的多机部署任务。利用playbook，用户可以：</p>
<ul>
<li>声明配置。</li>
<li>编排在多机上执行的任务的步骤及顺序。</li>
<li>同步或者异步地执行这些任务。</li>
</ul>
<img src=/images/ansible-playbooks.png />

<p>Ansible playbook由一个或者多个play组成，并按照从上到下的顺序执行，每个play至少包含两个部分：</p>
<ul>
<li>用pattern来指定被管理的机器。</li>
<li>要执行的任务(task)。</li>
</ul>
<p>Ansible playbook有如下特点：</p>
<ul>
<li>在匹配的主机上，默认按顺序执行定义的任务，一次执行一个。</li>
<li>每个任务用指定的参数来执行一个ansible模块(module)。</li>
<li>如果任务在某个主机上失败，ansible则不会在该主机上执行接下来的所有任务。</li>
<li>大多数的ansible模块会检查机器的状态是否已经满足了module定义的状态，如果已经满足，则退出任务的执行。所以ansible模块的执行是幂等的。</li>
<li>task可以用block组织起来，然后利用<code>rescue</code>和<code>always</code>做异常处理。类似于<code>try...except...finally</code>。</li>
</ul>
<p>Ansible playbook的相关命令：</p>
<ul>
<li><code>$ ansible-playbook playbook.yaml -f 10</code>: Fork出10个子进程来执行playbook中定义的任务。</li>
<li><code>$ ansible-lint playbook.yaml</code>: 检查playbook的定义。</li>
</ul>
<p>例如，用ansible playbook来列出主机上家目录下的文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### playbook.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">List</span> <span class="string">files</span> <span class="string">of</span> <span class="string">master</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">List</span> <span class="string">files</span></span><br><span class="line">     <span class="attr">ansible.builtin.find:</span></span><br><span class="line">       <span class="attr">paths:</span> <span class="string">/root</span></span><br><span class="line">     <span class="attr">register:</span> <span class="string">out</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">the</span> <span class="string">List</span></span><br><span class="line">     <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">       <span class="attr">var:</span> <span class="string">out</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">List</span> <span class="string">files</span> <span class="string">of</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">List</span> <span class="string">files</span></span><br><span class="line">     <span class="attr">ansible.builtin.find:</span></span><br><span class="line">       <span class="attr">paths:</span> <span class="string">/root</span></span><br><span class="line">     <span class="attr">register:</span> <span class="string">out</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">the</span> <span class="string">List</span></span><br><span class="line">     <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">       <span class="attr">var:</span> <span class="string">out</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i hosts.yaml playbook.yaml -f 10</span><br><span class="line"></span><br><span class="line">PLAY [List files of master nodes]</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts]</span><br><span class="line">ok: [master-node]</span><br><span class="line"></span><br><span class="line">TASK [List files]</span><br><span class="line">ok: [master-node]</span><br><span class="line"></span><br><span class="line">TASK [Print the List]</span><br><span class="line">ok: [master-node] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;out&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;examined&quot;</span>: 9,</span><br><span class="line">        <span class="string">&quot;failed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;files&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;atime&quot;</span>: 1668424993.3145647,</span><br><span class="line">                <span class="string">&quot;ctime&quot;</span>: 1668424993.3145647,</span><br><span class="line">                <span class="string">&quot;dev&quot;</span>: 64513,</span><br><span class="line">                <span class="string">&quot;gid&quot;</span>: 0,</span><br><span class="line">                <span class="string">&quot;gr_name&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">                <span class="string">&quot;inode&quot;</span>: 33538,</span><br><span class="line">                <span class="string">&quot;isblk&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;ischr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;isdir&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;isfifo&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;isgid&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;islnk&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;isreg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;issock&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;isuid&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;0644&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mtime&quot;</span>: 1668424993.3145647,</span><br><span class="line">                <span class="string">&quot;nlink&quot;</span>: 1,</span><br><span class="line">                <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/root/a.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;pw_name&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">                <span class="string">&quot;rgrp&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;roth&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;rusr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">                <span class="string">&quot;uid&quot;</span>: 0,</span><br><span class="line">                <span class="string">&quot;wgrp&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;woth&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;wusr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;xgrp&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;xoth&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;xusr&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;matched&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;All paths examined&quot;</span>,</span><br><span class="line">        <span class="string">&quot;skipped_paths&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY [List files of nodes]</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts]</span><br><span class="line"></span><br><span class="line">TASK [List files]</span><br><span class="line">ok: [node-1]</span><br><span class="line"></span><br><span class="line">TASK [Print the List]</span><br><span class="line">ok: [node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;out&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;examined&quot;</span>: 8,</span><br><span class="line">        <span class="string">&quot;failed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;files&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;matched&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;All paths examined&quot;</span>,</span><br><span class="line">        <span class="string">&quot;skipped_paths&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP </span><br><span class="line">master-node                : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">node-1                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h3 id="如何在playbook中使用过滤器"><a href="#如何在playbook中使用过滤器" class="headerlink" title="如何在playbook中使用过滤器?"></a>如何在playbook中使用过滤器?</h3><ol>
<li>处理未定义的变量</li>
</ol>
<ul>
<li><code>&#123;&#123; some_var | default('admin', true) &#125;&#125;</code>: 给some_var设置默认值为’admin’，true表示some_var是false或者空字符串的时候也使用默认值。</li>
<li><code>&#123;&#123; mode | default(omit) &#125;&#125;</code>: 如果mode没有定义就忽略它，直接使用系统的默认值。</li>
<li><code>&#123;&#123; some_var | mandatory &#125;&#125;</code>: 如果some_var没有定义，则ansible会执行失败。</li>
</ul>
<ol start="2">
<li>根据变量的值是true/false/null来返回不同的结果， 如<code>&#123;&#123; enabled | ternary('no shutdown', 'shutdown', omit) &#125;&#125;</code></li>
<li>使用过滤器<code>type_debug</code>, <code>dict2items</code>及<code>items2dict</code>来获取或改变数据类型。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">list</span> <span class="string">to</span> <span class="string">dict</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">colors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fruit:</span> <span class="string">apple</span></span><br><span class="line">        <span class="attr">color:</span> <span class="string">red</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fruit:</span> <span class="string">pear</span></span><br><span class="line">        <span class="attr">color:</span> <span class="string">yellow</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fruit:</span> <span class="string">grapefruit</span></span><br><span class="line">        <span class="attr">color:</span> <span class="string">yellow</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">dict</span></span><br><span class="line">     <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; colors | items2dict(key_name=&#x27;fruit&#x27;, value_name=&#x27;color&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;&#123;&#x27;apple&#x27;: &#x27;red&#x27;, &#x27;pear&#x27;: &#x27;yellow&#x27;, &#x27;grapefruit&#x27;: &#x27;yellow&#x27;&#125;&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">dict</span> <span class="string">to</span> <span class="string">list</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">fruits:</span></span><br><span class="line">      <span class="attr">apple:</span> <span class="string">red</span></span><br><span class="line">      <span class="attr">pear:</span> <span class="string">yellow</span></span><br><span class="line">      <span class="attr">grapefruit:</span> <span class="string">yellow</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">list</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; fruits | dict2items(key_name=&#x27;fruit&#x27;, value_name=&#x27;color&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#123;&#x27;fruit&#x27;: &#x27;apple&#x27;, &#x27;color&#x27;: &#x27;red&#x27;&#125;, &#123;&#x27;fruit&#x27;: &#x27;pear&#x27;, &#x27;color&#x27;: &#x27;yellow&#x27;&#125;, &#123;&#x27;fruit&#x27;: &#x27;grapefruit&#x27;, &#x27;color&#x27;: &#x27;yellow&#x27;&#125;]&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>强制类型转换。<code>&#123;&#123; some_var | bool &#125;&#125;</code>, <code>&#123;&#123; some_var | to_json &#125;&#125;</code>, <code>&#123;&#123; some_var | to_nice_yaml(indent=4) &#125;&#125;</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook: filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">to_json,</span> <span class="string">to_nice_json</span> <span class="string">and</span> <span class="string">from_json</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">fruits:</span></span><br><span class="line">      <span class="attr">apple:</span> <span class="string">red</span></span><br><span class="line">      <span class="attr">pear:</span> <span class="string">yellow</span></span><br><span class="line">      <span class="attr">grapefruit:</span> <span class="string">yellow</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">to_json</span></span><br><span class="line">     <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; fruits | to_json&#125;&#125;</span>&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">to_nice_json</span></span><br><span class="line">     <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; fruits | to_nice_json&#125;&#125;</span>&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">from_json</span></span><br><span class="line">     <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; fruits | to_nice_json | from_json&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&#123;\&quot;apple\&quot;: \&quot;red\&quot;, \&quot;pear\&quot;: \&quot;yellow\&quot;, \&quot;grapefruit\&quot;: \&quot;yellow\&quot;&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&#123;\n    \&quot;apple\&quot;: \&quot;red\&quot;,\n    \&quot;grapefruit\&quot;: \&quot;yellow\&quot;,\n    \&quot;pear\&quot;: \&quot;yellow\&quot;\n&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;apple&quot;</span>: <span class="string">&quot;red&quot;</span>,</span><br><span class="line">        <span class="string">&quot;grapefruit&quot;</span>: <span class="string">&quot;yellow&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pear&quot;</span>: <span class="string">&quot;yellow&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>zip</code>, <code>zip_longest</code>合并列表。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">zip,</span> <span class="string">zip_longest</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">indexes:</span> [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">list</span> <span class="string">with</span> <span class="string">zip.</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; indexes | zip([&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[(0, &#x27;a&#x27;), (1, &#x27;b&#x27;), (2, &#x27;c&#x27;), (3, &#x27;d&#x27;)]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">list</span> <span class="string">with</span> <span class="string">zip_longest.</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; indexes | zip_longest([&#x27;a&#x27;], fillvalue=&#x27;x&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[(0, &#x27;a&#x27;), (1, &#x27;x&#x27;), (2, &#x27;x&#x27;), (3, &#x27;x&#x27;)]&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>subelements</code>合并对象本身及其子元素。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">zip,</span> <span class="string">zip_longest</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Han</span> <span class="string">Meimei</span></span><br><span class="line">        <span class="attr">roles:</span> [<span class="string">&#x27;developer&#x27;</span>, <span class="string">&#x27;tester&#x27;</span>, <span class="string">&#x27;sre&#x27;</span>]</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Li</span> <span class="string">lei</span></span><br><span class="line">        <span class="attr">roles:</span> [<span class="string">&#x27;developer&#x27;</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">combined</span> <span class="string">msg.</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0.name &#125;&#125;</span> is a <span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>.&quot;</span></span><br><span class="line">     <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | subelements(&#x27;roles&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=[&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Han Meimei&#x27;</span>, <span class="string">&#x27;roles&#x27;</span>: [<span class="string">&#x27;developer&#x27;</span>, <span class="string">&#x27;tester&#x27;</span>, <span class="string">&#x27;sre&#x27;</span>]&#125;, <span class="string">&#x27;developer&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Han Meimei is a developer.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Han Meimei&#x27;</span>, <span class="string">&#x27;roles&#x27;</span>: [<span class="string">&#x27;developer&#x27;</span>, <span class="string">&#x27;tester&#x27;</span>, <span class="string">&#x27;sre&#x27;</span>]&#125;, <span class="string">&#x27;tester&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Han Meimei is a tester.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Han Meimei&#x27;</span>, <span class="string">&#x27;roles&#x27;</span>: [<span class="string">&#x27;developer&#x27;</span>, <span class="string">&#x27;tester&#x27;</span>, <span class="string">&#x27;sre&#x27;</span>]&#125;, <span class="string">&#x27;sre&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Han Meimei is a sre.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Li lei&#x27;</span>, <span class="string">&#x27;roles&#x27;</span>: [<span class="string">&#x27;developer&#x27;</span>]&#125;, <span class="string">&#x27;developer&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Li lei is a developer.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>combine</code>来合并字典。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">combine</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">Han</span> <span class="string">Meimei</span></span><br><span class="line">      <span class="attr">roles:</span> [<span class="string">&#x27;developer&#x27;</span>, <span class="string">&#x27;tester&#x27;</span>, <span class="string">&#x27;sre&#x27;</span>]</span><br><span class="line">      <span class="attr">scores:</span></span><br><span class="line">        <span class="attr">math:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">combined</span> <span class="string">user.</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user | combine(&#123; &#x27;roles&#x27;: [&#x27;designer&#x27;, &#x27;sre&#x27;], &#x27;scores&#x27;: &#123; &#x27;english&#x27;: 80 &#125; &#125;, list_merge=&#x27;append_rp&#x27;, recursive=True) | from_yaml &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Han Meimei&quot;</span>,</span><br><span class="line">        <span class="string">&quot;roles&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;developer&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tester&quot;</span>,</span><br><span class="line">            <span class="string">&quot;designer&quot;</span>,</span><br><span class="line">            <span class="string">&quot;sre&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;scores&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;english&quot;</span>: 80,</span><br><span class="line">            <span class="string">&quot;math&quot;</span>: 100</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>map</code>从列表或字典中抽取数据。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">map</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">list.</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; [0,2] | map(&#x27;extract&#x27;, [&#x27;x&#x27;,&#x27;y&#x27;,&#x27;z&#x27;]) | list | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;x&#x27;, &#x27;z&#x27;]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">dict.</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; [&#x27;x&#x27;,&#x27;y&#x27;] | map(&#x27;extract&#x27;, &#123;&#x27;x&#x27;: 42, &#x27;y&#x27;: 31&#125;) | list | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[42, 31]&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>ansible.builtin.permutations</code>和<code>ansible.builtin.combinations</code>来获取列表的排列与组合。</li>
<li>使用<code>product</code>来获取两个列表的笛卡尔积。</li>
<li>使用<code>json_query</code>来获取json的子元素。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">json_query</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">&quot;domain_definition&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;domain&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;cluster&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;cluster1&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;cluster2&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;server&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;server11&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;cluster&quot;:</span> <span class="string">&quot;cluster1&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;port&quot;:</span> <span class="string">&quot;8080&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;server12&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;cluster&quot;:</span> <span class="string">&quot;cluster1&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;port&quot;:</span> <span class="string">&quot;8090&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;server21&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;cluster&quot;:</span> <span class="string">&quot;cluster2&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;port&quot;:</span> <span class="string">&quot;9080&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;server22&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;cluster&quot;:</span> <span class="string">&quot;cluster2&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;port&quot;:</span> <span class="string">&quot;9090&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;library&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;lib1&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;target&quot;:</span> <span class="string">&quot;cluster1&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;lib2&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;target&quot;:</span> <span class="string">&quot;cluster2&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; domain_definition | json_query(&#x27;domain.cluster[*].name&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;cluster1&#x27;, &#x27;cluster2&#x27;]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; domain_definition | json_query(&#x27;domain.server[?cluster==`cluster1`].port&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;8080&#x27;, &#x27;8090&#x27;]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; domain_definition | json_query(&#x27;domain.server[?cluster==`cluster2`].&#123;name: name, port: port&#125;&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#123;&#x27;name&#x27;: &#x27;server21&#x27;, &#x27;port&#x27;: &#x27;9080&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;server22&#x27;, &#x27;port&#x27;: &#x27;9090&#x27;&#125;]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; domain_definition | json_query(&#x27;domain.server[?starts_with(name, `server1`)].port&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;8080&#x27;, &#x27;8090&#x27;]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; domain_definition | json_query(&#x27;domain.server[?contains(name, `server1`)].port&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;8080&#x27;, &#x27;8090&#x27;]&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>用<code>random</code>生成随机数。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">random</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;] | random &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;msg&quot;: &quot;a&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 60 | random &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;msg&quot;: &quot;39&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 101 | random(step=10) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;msg&quot;: &quot;80&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 101 | random(start=1, step=10) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;msg&quot;: &quot;21&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 60 | random(seed=inventory_hostname) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;msg&quot;: &quot;42&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>用<code>shuffle</code>可以打乱列表。 <code>&#123;&#123; ['a','b','c'] | shuffle(seed=inventory_hostname) &#125;&#125;</code></li>
<li>用<code>max</code>, <code>min</code>, <code>flatten</code>处理列表。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">list</span> <span class="string">management</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nums:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">    <span class="attr">nested_nums:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>]]</span><br><span class="line">    <span class="attr">dict_list:</span> [&#123;<span class="attr">&#x27;val&#x27;:</span> <span class="number">1</span>&#125;, &#123;<span class="attr">&#x27;val&#x27;:</span> <span class="number">2</span>&#125;]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; nums | min &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;1&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; nums | max &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;3&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; dict_list | max(attribute=&#x27;val&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;&#123;&#x27;val&#x27;: 2&#125;&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; nested_nums | flatten(levels=1) | string  &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[1, 2, 3, 4, 5]&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>unique</code>, <code>union</code>, <code>intersect</code>, <code>difference</code>, <code>symmetric_difference</code>给列表做集合运算。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">sets</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">list1:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">4</span>]</span><br><span class="line">    <span class="attr">list2:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; list1 | unique | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[1, 2, 3, 4, 5]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; list1 | union(list2) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[1, 2, 3, 4, 5, 6, 7, 8]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; list1 | intersect(list2) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[1, 2]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; list1 | difference(list2) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[3, 4, 5]&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; list1 | symmetric_difference(list2) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[3, 4, 5, 6, 7, 8]&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>ipaddr</code>, <code>ipv4</code>, <code>ipv6</code>处理IP地址。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">IP</span> <span class="string">address</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">s:</span> <span class="string">&quot;hello9.128.1.1world&quot;</span></span><br><span class="line">    <span class="attr">invalid_ip:</span> <span class="string">&quot;9.1.1.314&quot;</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    <span class="attr">cidr:</span> <span class="string">&quot;192.0.2.1/24&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; s | ansible.utils.ipaddr &#125;&#125;</span>&quot;</span> <span class="comment"># false</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; s | ansible.utils.ipv4 &#125;&#125;</span>&quot;</span> <span class="comment"># false</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; s | ansible.utils.ipv6 &#125;&#125;</span>&quot;</span> <span class="comment"># false</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; s | ansible.utils.ipaddr(&#x27;address&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># false</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; invalid_ip | ansible.utils.ipaddr &#125;&#125;</span>&quot;</span> <span class="comment"># false</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; cidr | ansible.utils.ipaddr(&#x27;address&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;192.0.2.1&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ip | ansible.utils.ipv4 &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;127.0.0.1&quot;</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ip | ansible.utils.ipaddr(&#x27;address&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>hash</code>, <code>checksum</code>, <code>password_hash</code>加密字符串和密码。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">hash,</span> <span class="string">checksum,</span> <span class="string">password_hash</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">pwd:</span> <span class="string">&quot;pass4root&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; pwd | hash(&#x27;sha1&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;0754b1729f43eb5e37007610e28a47bd60531b97&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; pwd | hash(&#x27;md5&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;f2feffd19d83fdac11a2e29c3e4d7fc6&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; pwd | checksum &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;0754b1729f43eb5e37007610e28a47bd60531b97&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; pwd | password_hash(&#x27;sha512&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;$6$rounds=656000$p3CTKl4HE5zC297h$/7MyWoqFwsug5n0aFaGh3CK2utVkxiuJW5wc04obh/NPPN2YiHe.XHlh4E/QXm4zNkR4zUg4zQEwzSCX03cLt/&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; pwd | password_hash(&#x27;sha256&#x27;, &#x27;mysecretsalt&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;$5$rounds=535000$mysecretsalt$UXdCeKTnnbG1O6cMAPkfEve5t17.eExAsSfxGYmd7H/&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>comment</code>, <code>urlencode</code>, <code>urlsplit</code>处理字符串。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">`comment`,</span> <span class="string">`urlencode`,</span> <span class="string">`urlsplit`</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">s:</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">&quot;http://user:password@www.example.com:9000/dir/index.html?query=term#fragment&quot;</span></span><br><span class="line">    <span class="attr">crn:</span> <span class="string">&quot;crn:v2:bluemix:uuid:a/accountid&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; s | comment(decoration=&#x27;# &#x27;, prefix=&#x27;######&#x27;, postfix=&#x27;######&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;######\n# hello world\n######&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; s | comment(&#x27;xml&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;&lt;!--\n -\n - hello world\n -\n--&gt;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; crn | urlencode &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;crn%3Av2%3Abluemix%3Auuid%3Aa/accountid&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; url | urlsplit(&#x27;hostname&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;www.example.com&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; url | urlsplit | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;&#123;&#x27;fragment&#x27;: &#x27;fragment&#x27;, &#x27;hostname&#x27;: &#x27;www.example.com&#x27;, &#x27;netloc&#x27;: &#x27;user:password@www.example.com:9000&#x27;, &#x27;password&#x27;: &#x27;password&#x27;, &#x27;path&#x27;: &#x27;/dir/index.html&#x27;, &#x27;port&#x27;: 9000, &#x27;query&#x27;: &#x27;query=term&#x27;, &#x27;scheme&#x27;: &#x27;http&#x27;, &#x27;username&#x27;: &#x27;user&#x27;&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>regex_search</code>, <code>regex_findall</code>, <code>regex_replace</code>, <code>regex_escape</code>处理字符串。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">`regex_search`,</span> <span class="string">`regex_findall`,</span> <span class="string">`regex_replace`,</span> <span class="string">`regex_escape`</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;server1/database42&#x27; | regex_search(&#x27;database[0-9]+&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;database42&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;foo\nBAR&#x27; | regex_search(&#x27;^bar&#x27;, multiline=True, ignorecase=True) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;BAR&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;server1/database42&#x27; | regex_search(&#x27;server([0-9]+)/database([0-9]+)&#x27;, &#x27;\\1&#x27;, &#x27;\\2&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;1&#x27;, &#x27;42&#x27;]&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;21/42&#x27; | regex_search(&#x27;(?P&lt;dividend&gt;[0-9]+)/(?P&lt;divisor&gt;[0-9]+)&#x27;, &#x27;\\g&lt;dividend&gt;&#x27;, &#x27;\\g&lt;divisor&gt;&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;21&#x27;, &#x27;42&#x27;]&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;ansible&#x27; | regex_search(&#x27;foobar&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &#x27;&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;ansible&#x27; | regex_search(&#x27;foobar&#x27;) == &#x27;&#x27; &#125;&#125;</span>&quot;</span> <span class="comment"># False</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;ansible&#x27; | regex_search(&#x27;foobar&#x27;) is none &#125;&#125;</span>&quot;</span> <span class="comment"># True</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;CAR\ntar\nfoo\nbar\n&#x27; | regex_findall(&#x27;^.ar$&#x27;, multiline=True, ignorecase=True) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;CAR&#x27;, &#x27;tar&#x27;, &#x27;bar&#x27;]&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;localhost:80&#x27; | regex_replace(&#x27;^(?P&lt;host&gt;.+):(?P&lt;port&gt;\\d+)$&#x27;, &#x27;\\g&lt;host&gt;, \\g&lt;port&gt;&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &#x27;localhost, 80&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;^f.*o(.*)$&#x27; | regex_escape() &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;\\^f\\.\\*o\\(\\.\\*\\)\\$&quot;</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure></li>
<li>使用<code>basename</code>, <code>dirname</code>, <code>expanduser</code>, <code>expandvars</code>, <code>realpath</code>, <code>relpath</code>, <code>splitext</code>, <code>first</code>, <code>last</code>, <code>path_join</code>处理文件路径。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">`basename`,</span> <span class="string">`dirname`,</span> <span class="string">`expanduser`,</span> <span class="string">`expandvars`,</span> <span class="string">`realpath`,</span> <span class="string">`relpath`,</span> <span class="string">`splitext`,</span> <span class="string">`first`,</span> <span class="string">`last`,</span> <span class="string">`path_join`</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">~/sen/a.txt</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | basename &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;a.txt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | dirname &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;~/sen&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | expanduser &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;/Users/senwang/sen/a.txt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | expandvars &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;~/sen/a.txt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | realpath &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;/Users/senwang/tools/ansible/~/sen/a.txt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | relpath(&#x27;/etc&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;../Users/senwang/tools/ansible/~/sen/a.txt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | splitext &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;(&#x27;~/sen/a&#x27;, &#x27;.txt&#x27;)&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | splitext | first &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;~/sen/a&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; (&#x27;/etc&#x27;, &#x27;dir&#x27;, &#x27;subdir&#x27;, &#x27;a.txt&#x27;) | path_join &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;/etc/dir/subdir/a.txt&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>join</code>, <code>split</code>, <code>b64decode</code>, <code>b64encode</code>处理字符串。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">`join`,</span> <span class="string">`split`,</span> <span class="string">`b64decode`,</span> <span class="string">`b64encode`</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; types | join(&#x27;,&#x27;) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;int,string,list,dict&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; types | join(&#x27;,&#x27;) | split(&#x27;,&#x27;) | string &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;[&#x27;int&#x27;, &#x27;string&#x27;, &#x27;list&#x27;, &#x27;dict&#x27;]&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;hello world&#x27; | b64encode | b64decode &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;hello world&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>to_uuid</code>处理UUID。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">`to_uuid`</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;string&#x27; | to_uuid &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;c7e8b99c-6668-5b4d-bdf9-26f4c0da60e5&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>to_datetime</code>, <code>strftime</code>处理时间和日期。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook filters.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">`to_datetime`,</span> <span class="string">`strftime`</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ((&#x27;2016-08-14 20:00:12&#x27; | to_datetime) - (&#x27;2015-12-25&#x27; | to_datetime(&#x27;%Y-%m-%d&#x27;))).total_seconds()  &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;20203212.0&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; ((&quot;2016-08-14 20:00:12&quot; | to_datetime) - (&quot;2016-08-14 18:00:00&quot; | to_datetime)).seconds  &#125;&#125;</span>&#x27;</span> <span class="comment"># &quot;7212&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; ((&quot;2016-08-14 20:00:12&quot; | to_datetime) - (&quot;2015-12-25&quot; | to_datetime(&quot;%Y-%m-%d&quot;))).days  &#125;&#125;</span>&#x27;</span> <span class="comment"># &quot;233&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;%H:%M:%S&#x27; | strftime &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;19:42:01&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;%Y-%m-%d %H:%M:%S&#x27; | strftime(0) &#125;&#125;</span>&quot;</span> <span class="comment"># &quot;1970-01-01 08:00:00&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;%Y-%m-%d&#x27; | strftime(1441357287) &#125;&#125;</span>&quot;</span>  <span class="comment"># &quot;2015-09-04&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="如何在受控节点上以其他用户的身份执行命令？"><a href="#如何在受控节点上以其他用户的身份执行命令？" class="headerlink" title="如何在受控节点上以其他用户的身份执行命令？"></a>如何在受控节点上以其他用户的身份执行命令？</h3><p>可以在play或者task上通过以下配置切换用户身份来执行play或者task。</p>
<p><code>become</code>: 设置为<code>yes</code>启用用户切换。<br><code>become_user</code>: 指定要切换的用户名，如果不指定默认为<code>root</code>用户。<br><code>become_method</code>: 指定<code>become</code>要使用的插件，如<code>su</code>, <code>sudo</code>等。</p>
<p>也可以在清单中为<code>group</code>或者节点设置<code>become</code>。</p>
<ul>
<li><code>ansible_become</code></li>
<li><code>ansible_become_user</code></li>
<li><code>ansible_become_password</code></li>
<li><code>ansible_become_method</code></li>
</ul>
<h3 id="如何在playbook中使用循环"><a href="#如何在playbook中使用循环" class="headerlink" title="如何在playbook中使用循环"></a>如何在playbook中使用循环</h3><ol>
<li>使用<code>loop</code>遍历简单列表。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">List</span> <span class="string">users</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">item.</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">user1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">user2</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>loop</code>遍历字典列表。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line">  <span class="attr">ansible.builtin.user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">groups:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.groups &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;testuser1&#x27;</span>, <span class="attr">groups:</span> <span class="string">&#x27;wheel&#x27;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;testuser2&#x27;</span>, <span class="attr">groups:</span> <span class="string">&#x27;root&#x27;</span> &#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>loop</code>和<code>dict2items</code>遍历字典。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">loop</span> <span class="string">dict</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Using</span> <span class="string">dict2items</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.key &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.value &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; tag_data | dict2items &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">tag_data:</span></span><br><span class="line">          <span class="attr">Environment:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">Application:</span> <span class="string">payment</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=&#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;Environment&#x27;</span>, <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;dev&#x27;</span>&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Environment - dev&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=&#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;Application&#x27;</span>, <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;payment&#x27;</span>&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Application - payment&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>register</code>将loop的结果保存到变量。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">loop</span> <span class="string">register</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Register</span> <span class="string">loop</span> <span class="string">output</span> <span class="string">as</span> <span class="string">a</span> <span class="string">variable</span></span><br><span class="line">      <span class="attr">ansible.builtin.shell:</span> <span class="string">&quot;echo <span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;one&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;two&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">echo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">echo</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">echo</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;echo&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;All items completed&quot;</span>,</span><br><span class="line">        <span class="string">&quot;results&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/opt/homebrew/bin/python3.10&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;ansible_loop_var&quot;</span>: <span class="string">&quot;item&quot;</span>,</span><br><span class="line">                <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;echo one&quot;</span>,</span><br><span class="line">                <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;0:00:00.007707&quot;</span>,</span><br><span class="line">                <span class="string">&quot;end&quot;</span>: <span class="string">&quot;2022-11-20 20:24:53.768577&quot;</span>,</span><br><span class="line">                <span class="string">&quot;failed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;invocation&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;module_args&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;_raw_params&quot;</span>: <span class="string">&quot;echo one&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;_uses_shell&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">&quot;argv&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;chdir&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;creates&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;executable&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;removes&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;stdin&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;stdin_add_newline&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">&quot;strip_empty_ends&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">&quot;warn&quot;</span>: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;item&quot;</span>: <span class="string">&quot;one&quot;</span>,</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;rc&quot;</span>: 0,</span><br><span class="line">                <span class="string">&quot;start&quot;</span>: <span class="string">&quot;2022-11-20 20:24:53.760870&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stderr_lines&quot;</span>: [],</span><br><span class="line">                <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;one&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;one&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;ansible_loop_var&quot;</span>: <span class="string">&quot;item&quot;</span>,</span><br><span class="line">                <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;echo two&quot;</span>,</span><br><span class="line">                <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;0:00:00.007317&quot;</span>,</span><br><span class="line">                <span class="string">&quot;end&quot;</span>: <span class="string">&quot;2022-11-20 20:24:53.973643&quot;</span>,</span><br><span class="line">                <span class="string">&quot;failed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;invocation&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;module_args&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;_raw_params&quot;</span>: <span class="string">&quot;echo two&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;_uses_shell&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">&quot;argv&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;chdir&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;creates&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;executable&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;removes&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;stdin&quot;</span>: null,</span><br><span class="line">                        <span class="string">&quot;stdin_add_newline&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">&quot;strip_empty_ends&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">&quot;warn&quot;</span>: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;item&quot;</span>: <span class="string">&quot;two&quot;</span>,</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;rc&quot;</span>: 0,</span><br><span class="line">                <span class="string">&quot;start&quot;</span>: <span class="string">&quot;2022-11-20 20:24:53.966326&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stderr_lines&quot;</span>: [],</span><br><span class="line">                <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;two&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;two&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;skipped&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;warnings&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;Platform darwin on host localhost is using the discovered Python interpreter at /opt/homebrew/bin/python3.10, but future installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-core/2.13/reference_appendices/interpreter_discovery.html for more information.&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>until</code>重试任务直到满足特定条件。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Retry</span> <span class="string">a</span> <span class="string">task</span> <span class="string">until</span> <span class="string">a</span> <span class="string">certain</span> <span class="string">condition</span> <span class="string">is</span> <span class="string">met</span></span><br><span class="line">  <span class="attr">ansible.builtin.shell:</span> <span class="string">/usr/bin/foo</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">until:</span> <span class="string">result.stdout.find(&quot;all</span> <span class="string">systems</span> <span class="string">go&quot;)</span> <span class="type">!=</span> <span class="number">-1</span></span><br><span class="line">  <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">delay:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>loop</code>遍历清单。<code>query</code>返回一个列表，<code>lookup</code>默认返回字符串，所以需要指定<code>wantlist=True</code>。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; query(&#x27;inventory_hostnames&#x27;, &#x27;all&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;inventory_hostnames&#x27;, &#x27;all&#x27;, wantlist=True) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">loop</span> <span class="string">register</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">all</span> <span class="string">the</span> <span class="string">hosts</span> <span class="string">in</span> <span class="string">the</span> <span class="string">inventory</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; groups[&#x27;all&#x27;] &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">all</span> <span class="string">the</span> <span class="string">hosts</span> <span class="string">in</span> <span class="string">the</span> <span class="string">current</span> <span class="string">play</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_play_batch &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">all</span> <span class="string">the</span> <span class="string">hosts</span> <span class="string">in</span> <span class="string">the</span> <span class="string">inventory</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; query(&#x27;inventory_hostnames&#x27;, &#x27;all&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">TASK [Show all the hosts <span class="keyword">in</span> the inventory] </span><br><span class="line">ok: [localhost] =&gt; (item=master-node) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;master-node&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=node-1) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;node-1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=localhost) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [Show all the hosts <span class="keyword">in</span> the current play] </span><br><span class="line">ok: [localhost] =&gt; (item=localhost) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [Show all the hosts <span class="keyword">in</span> the inventory] </span><br><span class="line">ok: [localhost] =&gt; (item=master-node) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;master-node&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=node-1) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;node-1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=localhost) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>loop_control</code>。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">loop</span> <span class="string">register</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">all</span> <span class="string">the</span> <span class="string">hosts</span> <span class="string">in</span> <span class="string">the</span> <span class="string">inventory</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; it &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; groups[&#x27;all&#x27;] &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop_control:</span></span><br><span class="line">        <span class="attr">loop_var:</span> <span class="string">it</span></span><br><span class="line">        <span class="attr">index_var:</span> <span class="string">i</span></span><br><span class="line">        <span class="attr">label:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; i &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">pause:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="如何在playbook中使用条件判断语句？"><a href="#如何在playbook中使用条件判断语句？" class="headerlink" title="如何在playbook中使用条件判断语句？"></a>如何在playbook中使用条件判断语句？</h3><ul>
<li>可以使用<code>when</code>为task指定执行条件。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">when</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list</span> <span class="string">all</span> <span class="string">files/dirs</span> <span class="string">in</span> <span class="string">$HOME</span> <span class="string">directory.</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ls</span> <span class="string">~</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">result.stdout_lines</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">result.stdout_lines</span> <span class="string">|</span> <span class="string">length</span> <span class="string">&gt;</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TASK [list all files/<span class="built_in">dirs</span> <span class="keyword">in</span> <span class="variable">$HOME</span> directory.]</span><br><span class="line">changed: [localhost]</span><br><span class="line">changed: [node-1]</span><br><span class="line">changed: [master-node]</span><br><span class="line"></span><br><span class="line">skipping: [master-node]</span><br><span class="line">skipping: [node-1]</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;result.stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Desktop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Documents&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Downloads&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Library&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Movies&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">...</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>也可以使用<code>when</code>来根据前一个任务的状态做不同的处理。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">when</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list</span> <span class="string">all</span> <span class="string">files/dirs</span> <span class="string">in</span> <span class="string">$HOME</span> <span class="string">directory.</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ls</span> <span class="string">~</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">result.stdout_lines</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">result.stdout_lines</span> <span class="string">|</span> <span class="string">length</span> <span class="string">&gt;</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">r</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">succeeded</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;Task on <span class="template-variable">&#123;&#123; inventory_hostname &#125;&#125;</span> succeeded.&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">r</span> <span class="string">is</span> <span class="string">succeeded</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">failed</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;Task on <span class="template-variable">&#123;&#123; inventory_hostname &#125;&#125;</span> failed.&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">r</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">skipped</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;Task on <span class="template-variable">&#123;&#123; inventory_hostname &#125;&#125;</span> skipped.&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">r</span> <span class="string">is</span> <span class="string">skipped</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">TASK [list all files/<span class="built_in">dirs</span> <span class="keyword">in</span> <span class="variable">$HOME</span> directory.]</span><br><span class="line">changed: [localhost]</span><br><span class="line">changed: [node-1]</span><br><span class="line">changed: [master-node]</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">print</span> result] </span><br><span class="line">skipping: [master-node]</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;result.stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Desktop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Documents&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Downloads&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Library&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Movies&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Pictures&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Public&quot;</span>,</span><br><span class="line">        <span class="string">&quot;data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;go&quot;</span>,</span><br><span class="line">        <span class="string">&quot;projects&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sdk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tmp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tools&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vpc&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">skipping: [node-1]</span><br><span class="line"></span><br><span class="line">ok: [master-node] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Task on master-node succeeded.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Task on node-1 succeeded.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Task on localhost succeeded.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">print</span> failed]</span><br><span class="line">skipping: [master-node]</span><br><span class="line">skipping: [node-1]</span><br><span class="line">skipping: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [<span class="built_in">print</span> skipped] </span><br><span class="line">skipping: [localhost]</span><br><span class="line">ok: [master-node] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Task on master-node skipped.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Task on node-1 skipped.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>当<code>when</code>和<code>import_tasks: tasks.yaml</code>一起使用时，tasks.yaml中的task也会判断<code>when</code>后面的条件。</li>
<li>当<code>when</code>和<code>include_tasks: tasks.yaml</code>一起使用时，tasks.yaml中的task不会去做<code>when</code>判断。</li>
<li>常用的用于条件测试的facts：<table>
<thead>
<tr>
<th>fact</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td><code>ansible_facts[&#39;distribution&#39;]</code></td>
<td>操作系统发行版名称，如<code>Redhat</code></td>
</tr>
<tr>
<td><code>ansible_facts[&#39;distribution_major_version&#39;]</code></td>
<td>操作系统发行版主版本号，如<code>16</code></td>
</tr>
<tr>
<td><code>ansible_facts[&#39;os_family&#39;]</code></td>
<td>操作系统发行版家族，如<code>Redhat</code>，<code>Debian</code>等</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="如何写条件判断语句中测试？"><a href="#如何写条件判断语句中测试？" class="headerlink" title="如何写条件判断语句中测试？"></a>如何写条件判断语句中测试？</h3><ul>
<li>语法： <code>variable is test_name</code> 例如： <code>result is failed</code></li>
<li>可以用<code>match</code>, <code>search</code>, <code>regex</code>测试字符创。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">string</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">&quot;https://example.com/users/foo/resources/bar&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;url not match: false.&quot;</span> <span class="comment"># &quot;url not match: false.&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">url</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match(&quot;example.com/users/.*/resources&quot;)</span> <span class="comment"># 必须从字符串开始就匹配</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;url match: true.&quot;</span> <span class="comment"># &quot;url match: true.&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">url</span> <span class="string">is</span> <span class="string">match(&quot;https://example.com/users/.*/resources&quot;)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;url search: true.&quot;</span> <span class="comment"># &quot;url search: true.&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">url</span> <span class="string">is</span> <span class="string">search(&quot;users/.*/resources/.*&quot;)</span>  <span class="comment"># 不要求从字符串开始就匹配</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;url regex: true&quot;</span> <span class="comment"># &quot;url regex: true&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">url</span> <span class="string">is</span> <span class="string">regex(&quot;example\.com/\w+/foo&quot;)</span></span><br></pre></td></tr></table></figure></li>
<li>用<code>vault_encrypted</code>测试变量是否vault的加密值。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-vault encrypt_string --vault-id dev --ask-vault-password --output password.yaml <span class="string">&quot;pass4root&quot;</span> --name passwd</span><br><span class="line">$ cat password.yaml</span><br><span class="line">passwd: !vault |</span><br><span class="line">          <span class="variable">$ANSIBLE_VAULT</span>;1.1;AES256</span><br><span class="line">          62343061653433353330663564333233356439306535663837346631393737646538626164366664</span><br><span class="line">          6532303034383336366530326438396536343232366131390a313863383336323838643863376663</span><br><span class="line">          61383561323338353031363861633032616135316638393139616161306538333563363038653665</span><br><span class="line">          3137616362386362380a643061326663396436393430343830653836636134626463613863613732</span><br><span class="line">          6539%</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">vault_encrypted</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars_files:</span> <span class="string">password.yaml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; (passwd is vault_encrypted) | ternary(&quot;Vault encrypted&quot;, &quot;Not vault encrypted&quot;) &#125;&#125;</span>&#x27;</span> <span class="comment"># &quot;Vault encrypted&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>用<code>truthy</code>和<code>falsy</code>来判断布尔值。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">truthy</span> <span class="string">and</span> <span class="string">falsy</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span> is Truthy&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">item</span> <span class="string">is</span> <span class="string">truthy(convert_bool=True)</span></span><br><span class="line">      <span class="attr">loop:</span> [<span class="string">&quot;&quot;</span>, <span class="number">0</span>, &#123;&#125;, [], <span class="string">&quot;hello world&quot;</span>, <span class="number">1</span>, &#123;<span class="attr">&quot;key&quot;:</span> <span class="string">&quot;value&quot;</span>&#125;, [<span class="number">1</span>]]</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span> is Falsy&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">item</span> <span class="string">is</span> <span class="string">falsy(convert_bool=True)</span></span><br><span class="line">      <span class="attr">loop:</span> [<span class="string">&quot;&quot;</span>, <span class="number">0</span>, &#123;&#125;, [], <span class="string">&quot;hello world&quot;</span>, <span class="number">1</span>, &#123;<span class="attr">&quot;key&quot;:</span> <span class="string">&quot;value&quot;</span>&#125;, [<span class="number">1</span>]]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=hello world) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;hello world is Truthy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;1 is Truthy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=&#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;value&#x27;</span>&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&#123;&#x27;key&#x27;: &#x27;value&#x27;&#125; is Truthy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[1]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;[1] is Truthy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ok: [localhost] =&gt; (item=) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot; is Falsy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=0) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;0 is Falsy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=&#123;&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&#123;&#125; is Falsy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;[] is Falsy&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>version</code>比较版本号。可用的操作符包括<code>&lt;, lt, &lt;=, le, &gt;, gt, &gt;=, ge, ==, =, eq, !=, &lt;&gt;, ne</code>。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">version</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;OS version <span class="template-variable">&#123;&#123; ansible_facts[&#x27;distribution_version&#x27;] &#125;&#125;</span> &gt;= 1.0&quot;</span> <span class="comment"># &quot;OS version 22.04 &gt;= 1.0&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;distribution_version&#x27;]</span> <span class="string">is</span> <span class="string">version(&#x27;1.0&#x27;,</span> <span class="string">&#x27;&gt;=&#x27;</span><span class="string">)</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>superset</code>和<code>subset</code>来比较集合。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">superset</span> <span class="string">and</span> <span class="string">subset</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">a:</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">    <span class="attr">b:</span> [<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;A includes B&quot;</span> <span class="comment"># &quot;A includes B&quot;</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">a</span> <span class="string">is</span> <span class="string">superset(b)</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;B is included in A&quot;</span> <span class="comment"># &quot;B is included in A&quot;</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">b</span> <span class="string">is</span> <span class="string">subset(a)</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>all</code>和<code>any</code>判断列表里的值是否全部为truthy。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">all</span> <span class="string">and</span> <span class="string">any</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">mylist:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 3 == 3 &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">myotherlist:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">False</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;all are true!&quot;</span> <span class="comment"># &quot;all are true!&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">mylist</span> <span class="string">is</span> <span class="string">all</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;at least one is true&quot;</span> <span class="comment"># &quot;at least one is true&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">myotherlist</span> <span class="string">is</span> <span class="string">any</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>directory, file, link, exists, abs, same_file, mount</code>来判断路径。</li>
<li>使用<code>human_readable</code>和<code>human_to_bytes</code>转换字节数。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">human_readable</span> <span class="string">and</span> <span class="string">human_to_bytes</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Human Readable&quot;</span></span><br><span class="line">      <span class="attr">assert:</span> <span class="comment"># &quot;All assertions passed&quot;</span></span><br><span class="line">        <span class="attr">that:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;1.00 Bytes&quot; == 1|human_readable&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;1.00 bits&quot; == 1|human_readable(isbits=True)&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;10.00 KB&quot; == 10240|human_readable&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;97.66 MB&quot; == 102400000|human_readable&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;0.10 GB&quot; == 102400000|human_readable(unit=&quot;G&quot;)&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;&quot;0.10 Gb&quot; == 102400000|human_readable(isbits=True, unit=&quot;G&quot;)&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Human to Bytes&quot;</span></span><br><span class="line">      <span class="attr">assert:</span>  <span class="comment"># &quot;All assertions passed&quot;</span></span><br><span class="line">        <span class="attr">that:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;&#x27;0&#x27;|human_to_bytes&#125;&#125;</span>        == 0&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;&#x27;0.1&#x27;|human_to_bytes&#125;&#125;</span>      == 0&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;&#x27;0.9&#x27;|human_to_bytes&#125;&#125;</span>      == 1&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;&#x27;1&#x27;|human_to_bytes&#125;&#125;</span>        == 1&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;&#x27;10.00 KB&#x27;|human_to_bytes&#125;&#125;</span> == 10240&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;   &#x27;11 MB&#x27;|human_to_bytes&#125;&#125;</span> == 11534336&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;  &#x27;1.1 GB&#x27;|human_to_bytes&#125;&#125;</span> == 1181116006&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;&#x27;10.00 Kb&#x27;|human_to_bytes(isbits=True)&#125;&#125;</span> == 10240&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>string, mapping, iterable, sequence, integer, number, float</code>判断数据类型。</li>
</ul>
<h3 id="如何获取用户输入？"><a href="#如何获取用户输入？" class="headerlink" title="如何获取用户输入？"></a>如何获取用户输入？</h3><p>Ansible可以在play中用<code>vars_prompt</code>获取用户输入。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">vars_prompt</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">username</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">What&#x27;s</span> <span class="string">your</span> <span class="string">user</span> <span class="string">name?</span></span><br><span class="line">      <span class="attr">private:</span> <span class="literal">false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">what&#x27;s</span> <span class="string">your</span> <span class="string">password?</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">Username</span> <span class="string">is</span> &#123;&#123; <span class="string">username</span> &#125;&#125;</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">Password</span> <span class="string">is</span> &#123;&#123; <span class="string">password</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i hosts.yaml playbook.yaml</span><br><span class="line">What<span class="string">&#x27;s your user name?: Sen Wang</span></span><br><span class="line"><span class="string">what&#x27;</span>s your password?:</span><br><span class="line"></span><br><span class="line">PLAY [Example <span class="keyword">for</span> vars_prompt]</span><br><span class="line"></span><br><span class="line">TASK [debug]</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Username is Sen Wang&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [debug]</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Password is 123456&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP</span><br><span class="line">localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h3 id="什么是fact和magic-variable"><a href="#什么是fact和magic-variable" class="headerlink" title="什么是fact和magic variable?"></a>什么是fact和magic variable?</h3><p>fact:</p>
<ul>
<li>Ansible facts是保存受控节点的系统信息的变量。在playbook中可以使用<code>ansible_facts</code>引用。</li>
<li>可以在play中使用<code>gather_facts: false</code>来禁止搜集受控节点信息并赋值给<code>ansible_facts</code>。</li>
<li>可以在<code>/etc/ansible/facts.d/x.fact</code>ini文件中设置自定义fact。然后用<code>ansible_local.x.section.var</code>来引用。</li>
</ul>
<p>Ansible magic variables是ansible的内置变量，用于保存ansible自身的一些信息。</p>
<ul>
<li><code>hostvars</code>: 保存所有受控节点的信息。</li>
<li><code>groups</code>: 保存清单中所有的group信息。</li>
<li><code>group_names</code>: 保存当前节点所在的所有组的信息。</li>
<li><code>inventory_hostname</code>: 保存当前节点的主机名。</li>
<li><code>ansible_play_hosts</code>: 保存当前play中所有active的主机名。</li>
<li><code>ansible_play_batch</code>: 保存当前play中正在运行的一批主机名，主机的个数和<code>serial</code>一致。</li>
<li><code>ansible_playbook_python</code>: 保存用于调用ansible命令行的python可执行文件路径。</li>
<li><code>inventory_dir</code>: 保存清单文件所在目录的路径。</li>
<li><code>playbook_dir</code>: 保存playbook所在目录的路径。</li>
<li><code>inventory_file</code>: 保存清单文件的路径。</li>
<li><code>role_path</code>: 只能在role中引用，保存当前role的路径。</li>
<li><code>ansible_check_mode</code>: 是否在命令行中使用<code>--check</code>启用了check mode。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">magic</span> <span class="string">variables.</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">magic_var_list:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; [hostvars[&#x27;master-node&#x27;].ansible_forks, groups, group_names, inventory_hostname, ansible_play_hosts, ansible_play_batch, ansible_playbook_python, inventory_dir, inventory_file, playbook_dir, ansible_check_mode] &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">       <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; magic_var_list &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i hosts.yaml playbook.yaml</span><br><span class="line"></span><br><span class="line">PLAY [Example <span class="keyword">for</span> magic variables.] </span><br><span class="line"></span><br><span class="line">TASK [set_fact]</span><br><span class="line">ok: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [debug]</span><br><span class="line">ok: [localhost] =&gt; (item=5) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: 5</span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=&#123;<span class="string">&#x27;all&#x27;</span>: [<span class="string">&#x27;master-node&#x27;</span>, <span class="string">&#x27;node-1&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>], <span class="string">&#x27;ungrouped&#x27;</span>: [], <span class="string">&#x27;master&#x27;</span>: [<span class="string">&#x27;master-node&#x27;</span>], <span class="string">&#x27;nodes&#x27;</span>: [<span class="string">&#x27;node-1&#x27;</span>], <span class="string">&#x27;prod&#x27;</span>: [<span class="string">&#x27;master-node&#x27;</span>, <span class="string">&#x27;node-1&#x27;</span>], <span class="string">&#x27;local&#x27;</span>: [<span class="string">&#x27;localhost&#x27;</span>]&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;all&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;master-node&quot;</span>,</span><br><span class="line">            <span class="string">&quot;node-1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;localhost&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;local&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;localhost&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;master&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;master-node&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;nodes&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;node-1&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;prod&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;master-node&quot;</span>,</span><br><span class="line">            <span class="string">&quot;node-1&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;ungrouped&quot;</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[<span class="string">&#x27;local&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;local&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=localhost) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[<span class="string">&#x27;localhost&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[<span class="string">&#x27;localhost&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=/opt/homebrew/Cellar/ansible/6.2.0/libexec/bin/python3.10) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;/opt/homebrew/Cellar/ansible/6.2.0/libexec/bin/python3.10&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=/Users/senwang/tools/ansible) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;/Users/senwang/tools/ansible&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=/Users/senwang/tools/ansible/hosts.yaml) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;/Users/senwang/tools/ansible/hosts.yaml&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=/Users/senwang/tools/ansible) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;/Users/senwang/tools/ansible&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=False) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP</span><br><span class="line">localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h3 id="如何使用role？"><a href="#如何使用role？" class="headerlink" title="如何使用role？"></a>如何使用role？</h3><p>role将变量、task、文件、handlers及其他的ansible元素以一定的目录结构组织起来，从而到达可重用及分享的目的。</p>
<p>role的目录结构如下：</p>
<ul>
<li>tasks/main.yml: role执行的task都放在该目录下。</li>
<li>handlers/main.yml: 存放role的handlers。</li>
<li>library/my_module.py: 存放自定义的module。</li>
<li>defaults/main.yml: 存放默认变量。</li>
<li>vars/main.yml: 存放其他变量。</li>
<li>files/main.yml: 存放文件。</li>
<li>templates/main.yml: 存放templates。</li>
<li>meta/main.yml: 存放role的metadata，包括role的依赖以及Galaxy的metadata。role所依赖的其他role会在这里指定，并且优先于role定义的task执行。</li>
<li>meta/argument_specs.yml: 如果role中有这个文件，那么在执行role时会先跑一个task来检查role的参数。</li>
</ul>
<p>role必须包含至少一个上述的目录。</p>
<p>Ansible查找role的路径优先级如下：</p>
<ul>
<li>collection</li>
<li>和playbook同目录下的roles目录</li>
<li>roles_path指定的目录。默认值为：<code>~/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles</code></li>
<li>playbook同目录</li>
</ul>
<p>用以下的方式引用role：</p>
<ul>
<li>play level使用<code>roles</code>静态引入</li>
<li>tasks level使用<code>include_role</code>动态引入</li>
<li>tasks level使用<code>import_role</code>静态引入</li>
</ul>
<p>引入role之后，play执行的顺序：</p>
<ul>
<li>play中定义的pre_tasks。</li>
<li>pre_tasks notify的handlers。</li>
<li>定义在roles中的role按顺序执行。</li>
<li>play定义的tasks。</li>
<li>role和task notify的handlers。</li>
<li>play中定义的post_tasks。</li>
<li>post_tasks notify的handlers。</li>
</ul>
<h3 id="如何理解动态的include和静态的import？"><a href="#如何理解动态的include和静态的import？" class="headerlink" title="如何理解动态的include和静态的import？"></a>如何理解动态的include和静态的import？</h3><p>playbook可以使用include动态地引入<code>task</code>,<code>role</code>和<code>variable</code>，也可使用import静态的引入<code>playbook</code>,<code>role</code>和<code>task</code>。<br>所谓静态，指的是ansible在运行开始就把被import的playbook/task/role引入playbook中，其task跟普通的task类似。而用include动态引入task/role，则是在执行到include的时候，用一个task将被引入的task/role引入进来。这样导致了import和include有如下区别。</p>
<table>
<thead>
<tr>
<th></th>
<th>include</th>
<th>import</th>
</tr>
</thead>
<tbody><tr>
<td>类型</td>
<td>动态</td>
<td>静态</td>
</tr>
<tr>
<td>处理时机</td>
<td>运行时遇到的时候处理</td>
<td>解析playbook的时候预处理</td>
</tr>
<tr>
<td>是否可以引入playbook</td>
<td>只能引入task/role</td>
<td>可以引入playbook</td>
</tr>
<tr>
<td>task的选项</td>
<td>只作用于该task</td>
<td>作用于被引入的所有task</td>
</tr>
<tr>
<td>是否可以用于loop</td>
<td>可以</td>
<td>不可以</td>
</tr>
<tr>
<td>–list-tags/–list-tasks</td>
<td>被引入的task/tag不可见</td>
<td>可以列出</td>
</tr>
<tr>
<td>notify handler</td>
<td>被引入的handler/task只能被整体执行</td>
<td>可以单独notify被引入的某一个task/handler</td>
</tr>
</tbody></table>
<h3 id="如何在受控节点之外的节点上运行task"><a href="#如何在受控节点之外的节点上运行task" class="headerlink" title="如何在受控节点之外的节点上运行task?"></a>如何在受控节点之外的节点上运行task?</h3><p>在task中使用<code>delegate_to</code>可以将task委派给其他的节点执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">delegate_to</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list</span> <span class="string">all</span> <span class="string">files/dirs</span> <span class="string">in</span> <span class="string">$HOME</span> <span class="string">directory.</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">&#x27;ls&#x27;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">node-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">result.stdout_lines</span> <span class="comment"># [&quot;file_on_node_1&quot;, &quot;snap&quot;]</span></span><br></pre></td></tr></table></figure>

<p>也可以使用<code>local_action</code>在控制节点上运行task。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">delegate_to</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list</span> <span class="string">all</span> <span class="string">files/dirs</span> <span class="string">in</span> <span class="string">$HOME</span> <span class="string">directory.</span></span><br><span class="line">      <span class="attr">local_action:</span> <span class="string">command</span> <span class="string">ls</span> <span class="string">~</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">result.stdout_lines</span> <span class="comment"># [&quot;Desktop&quot;, &quot;Documents&quot;, &quot;Downloads&quot;, &quot;Library&quot;...]</span></span><br></pre></td></tr></table></figure>

<p>ansible默认收集的是当前受控节点的facts，如果希望收集delegate_to节点的facts可以用<code>delegate_facts: true</code>设置。</p>
<h3 id="如何使用handler？"><a href="#如何使用handler？" class="headerlink" title="如何使用handler？"></a>如何使用handler？</h3><ul>
<li>handler是一种特殊的task，它只有被别的task使用<code>notify</code>通知且通知的task的状态为<code>changed</code>时才会运行。</li>
<li>可以使用<code>listen</code>让多个handler监听同一个notify。</li>
<li>handler通常只在一组task或者role之后运行一次，即使它被多次notify。</li>
<li>可以在task中使用<code>meta: flush_handlers</code>提前运行handler。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">handler</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">file_name:</span> <span class="string">&quot;a.txt&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">new</span> <span class="string">file.</span></span><br><span class="line">      <span class="attr">file:</span> </span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;~/<span class="template-variable">&#123;&#123; file_name &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">      <span class="attr">notify:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Print</span> <span class="string">file</span> <span class="string">created</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">file</span> <span class="string">created</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;File <span class="template-variable">&#123;&#123; file_name &#125;&#125;</span> created.&quot;</span> <span class="comment"># File a.txt created.</span></span><br><span class="line">      <span class="attr">listen:</span> <span class="string">Print</span> <span class="string">message</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="如何处理错误？"><a href="#如何处理错误？" class="headerlink" title="如何处理错误？"></a>如何处理错误？</h3><ul>
<li>一个task在某个节点执行失败后(状态为failed)，后续的task也不会在该节点上执行了。 可以使用<code>ignore_errors: true</code>来继续执行后续的task。</li>
<li>使用<code>ignore_unreachable: true</code>来忽略网络错误。</li>
<li>使用<code>meta: clear_host_error</code>来清空被标记为unreachable的节点，后续的task才能重新尝试去连接这些主机。</li>
<li>handler在task失败后就不会被触发，可以在play上指定<code>force_handlers: True</code>来强制运行handler。</li>
<li>使用<code>failed_when</code>和<code>changed_when</code>来定义task是成功还是失败。</li>
<li>使用<code>any_errors_fatal: true</code>在第一个失败的任务后中断所有任务和play的执行。</li>
<li><code>max_fail_percentage: 30</code>指定在30%的主机执行任务失败后终止后续任务和play的执行。</li>
</ul>
<h3 id="如何给受控节点设置环境变量？"><a href="#如何给受控节点设置环境变量？" class="headerlink" title="如何给受控节点设置环境变量？"></a>如何给受控节点设置环境变量？</h3><p>可以在play,block,task级别使用<code>environment</code>给受控节点设置环境变量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">for</span> <span class="string">environment</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">environment</span> <span class="string">variable</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">$key</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">value</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Print</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">result.stdout_lines</span> <span class="comment"># [&quot;value&quot;]</span></span><br></pre></td></tr></table></figure>

<h3 id="如何使用ansible模块？"><a href="#如何使用ansible模块？" class="headerlink" title="如何使用ansible模块？"></a>如何使用ansible模块？</h3><p>Ansible module是最终跑在受控节点上的ansible组件，负责完成任务，维护受控节点状态并最终给控制节点返回结果。</p>
<ul>
<li>可以用<code>$ ansible-doc -l</code>查看所有的模块。</li>
<li>可以在play, block, task level用<code>module_defaults</code>给ansible模块指定默认参数。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">module_defaults:</span></span><br><span class="line">    <span class="attr">ansible.builtin.file:</span></span><br><span class="line">      <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure></li>
<li>可以在<code>/etc/ansible/plugin_filters.yml</code>文件中禁止ansible加载指定的模块。</li>
</ul>
<h3 id="什么是Ansible插件"><a href="#什么是Ansible插件" class="headerlink" title="什么是Ansible插件?"></a>什么是Ansible插件?</h3><p>Ansible 插件(plugin)是对Ansible核心功能的增强，plugin可以分为如下几类：</p>
<ul>
<li>Action plugins</li>
<li>Become plugins</li>
<li>Cache plugins</li>
<li>Callback plugins</li>
<li>Cliconf plugins</li>
<li>Connection plugins</li>
<li>Docs fragments</li>
<li>Filter plugins</li>
<li>Httpapi plugins</li>
<li>Inventory plugins</li>
<li>Lookup plugins</li>
<li>Modules</li>
<li>Module utilities</li>
<li>Netconf plugins</li>
<li>Shell plugins</li>
<li>Strategy plugins</li>
<li>Terminal plugins</li>
<li>Test plugins</li>
<li>Vars plugins</li>
</ul>
<p>可以在<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/plugins/plugins.html">这里</a>获得所有插件的说明。</p>
<h3 id="Collection是什么？"><a href="#Collection是什么？" class="headerlink" title="Collection是什么？"></a>Collection是什么？</h3><p>Collection是Ansible的分发格式，也就是所谓的包，用户可以把自己的role,playbook,module,plugin以collection的形式放在分发服务器上，供其他用户安装使用。可以在<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index.html#list-of-collections">这里</a>找到官方仓库的collection列表。<br>要使用一个collection，用户需要：</p>
<ol>
<li>使用命令<code>$ ansible-galaxy collection list</code>查看已经安装的collection。</li>
<li>使用命令<code>$ ansible-galaxy collection install space_name.collection_name</code>安装一个collection。</li>
<li>安装完成之后就可以在playbook的task中以<code>space_name.collection_name.module_name</code>来使用了。</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">三木</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wangsen.site/2022/11/09/Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://wangsen.site/2022/11/09/Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wangsen.site" target="_blank">三木的技术博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a></div><div class="post_share"><div class="social-share" data-image="/images/ansible.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/images/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/images/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/27/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B/"><img class="prev-cover" src="/images/go.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Go语言中的集合类型</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/06/OpenAPI-%E6%A6%82%E8%A6%81/"><img class="next-cover" src="https://images.unsplash.com/photo-1580983219883-8463619d50e5?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2670&amp;q=80" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">OpenAPI 概要</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">三木</div><div class="author-info__description">Honesty and diligence should be your eternal mates.</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">134</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">80</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sanmuny"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/sanmuny" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:kelvin.xupt@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎访问我的技术博客，如果您觉得我的文章对您有所帮助，欢迎打赏和分享！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ansible%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">Ansible是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AAAnsible%E6%B8%85%E5%8D%95"><span class="toc-number">2.</span> <span class="toc-text">如何写一个Ansible清单?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F%EF%BC%9F"><span class="toc-number">3.</span> <span class="toc-text">如何使用变量？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E6%B8%85%E5%8D%95%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%8F%98%E9%87%8F%EF%BC%9F"><span class="toc-number">4.</span> <span class="toc-text">如何在清单中添加变量？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F%E6%9D%A5%E5%8C%B9%E9%85%8D%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%EF%BC%9F"><span class="toc-number">5.</span> <span class="toc-text">如何使用模式来匹配目标主机？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E4%B8%B4%E6%97%B6%E5%91%BD%E4%BB%A4%EF%BC%9F"><span class="toc-number">6.</span> <span class="toc-text">如何如何执行临时命令？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jinja2%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">7.</span> <span class="toc-text">jinja2是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ansible-playbooks%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">8.</span> <span class="toc-text">Ansible playbooks是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8playbook%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">9.</span> <span class="toc-text">如何在playbook中使用过滤器?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E5%8F%97%E6%8E%A7%E8%8A%82%E7%82%B9%E4%B8%8A%E4%BB%A5%E5%85%B6%E4%BB%96%E7%94%A8%E6%88%B7%E7%9A%84%E8%BA%AB%E4%BB%BD%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%EF%BC%9F"><span class="toc-number">10.</span> <span class="toc-text">如何在受控节点上以其他用户的身份执行命令？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8playbook%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%BE%AA%E7%8E%AF"><span class="toc-number">11.</span> <span class="toc-text">如何在playbook中使用循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8playbook%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5%EF%BC%9F"><span class="toc-number">12.</span> <span class="toc-text">如何在playbook中使用条件判断语句？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%86%99%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5%E4%B8%AD%E6%B5%8B%E8%AF%95%EF%BC%9F"><span class="toc-number">13.</span> <span class="toc-text">如何写条件判断语句中测试？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%EF%BC%9F"><span class="toc-number">14.</span> <span class="toc-text">如何获取用户输入？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFfact%E5%92%8Cmagic-variable"><span class="toc-number">15.</span> <span class="toc-text">什么是fact和magic variable?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8role%EF%BC%9F"><span class="toc-number">16.</span> <span class="toc-text">如何使用role？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%8A%A8%E6%80%81%E7%9A%84include%E5%92%8C%E9%9D%99%E6%80%81%E7%9A%84import%EF%BC%9F"><span class="toc-number">17.</span> <span class="toc-text">如何理解动态的include和静态的import？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E5%8F%97%E6%8E%A7%E8%8A%82%E7%82%B9%E4%B9%8B%E5%A4%96%E7%9A%84%E8%8A%82%E7%82%B9%E4%B8%8A%E8%BF%90%E8%A1%8Ctask"><span class="toc-number">18.</span> <span class="toc-text">如何在受控节点之外的节点上运行task?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8handler%EF%BC%9F"><span class="toc-number">19.</span> <span class="toc-text">如何使用handler？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF%EF%BC%9F"><span class="toc-number">20.</span> <span class="toc-text">如何处理错误？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%BB%99%E5%8F%97%E6%8E%A7%E8%8A%82%E7%82%B9%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%9F"><span class="toc-number">21.</span> <span class="toc-text">如何给受控节点设置环境变量？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8ansible%E6%A8%A1%E5%9D%97%EF%BC%9F"><span class="toc-number">22.</span> <span class="toc-text">如何使用ansible模块？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFAnsible%E6%8F%92%E4%BB%B6"><span class="toc-number">23.</span> <span class="toc-text">什么是Ansible插件?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Collection%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">24.</span> <span class="toc-text">Collection是什么？</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/14/%E4%BC%81%E4%B8%9A%E7%BA%A7Kubernetes%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" title="企业级Kubernetes离线部署指南"><img src="/images/k8s.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级Kubernetes离线部署指南"/></a><div class="content"><a class="title" href="/2025/03/14/%E4%BC%81%E4%B8%9A%E7%BA%A7Kubernetes%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" title="企业级Kubernetes离线部署指南">企业级Kubernetes离线部署指南</a><time datetime="2025-03-14T14:44:12.000Z" title="发表于 2025-03-14 22:44:12">2025-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/14/Kubernetes%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Kubernetes复习笔记"><img src="/images/k8s.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes复习笔记"/></a><div class="content"><a class="title" href="/2025/03/14/Kubernetes%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Kubernetes复习笔记">Kubernetes复习笔记</a><time datetime="2025-03-14T14:36:52.629Z" title="发表于 2025-03-14 22:36:52">2025-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/27/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" title="快速排序"><img src="/images/bg3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="快速排序"/></a><div class="content"><a class="title" href="/2024/12/27/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" title="快速排序">快速排序</a><time datetime="2024-12-27T13:16:56.000Z" title="发表于 2024-12-27 21:16:56">2024-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/13/Argo-v-s-Tekton/" title="Argo workflow v.s. Tekton"><img src="/images/devops.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Argo workflow v.s. Tekton"/></a><div class="content"><a class="title" href="/2024/12/13/Argo-v-s-Tekton/" title="Argo workflow v.s. Tekton">Argo workflow v.s. Tekton</a><time datetime="2024-12-13T11:27:34.000Z" title="发表于 2024-12-13 19:27:34">2024-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/04/%E5%A6%82%E4%BD%95%E7%BB%99%E4%BA%91%E8%AE%A1%E7%AE%97%E7%94%A8%E6%88%B7%E6%8F%90%E4%BE%9B%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/" title="如何给云计算用户提供安全可靠的操作系统镜像"><img src="/images/bg4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如何给云计算用户提供安全可靠的操作系统镜像"/></a><div class="content"><a class="title" href="/2024/12/04/%E5%A6%82%E4%BD%95%E7%BB%99%E4%BA%91%E8%AE%A1%E7%AE%97%E7%94%A8%E6%88%B7%E6%8F%90%E4%BE%9B%E5%AE%89%E5%85%A8%E5%8F%AF%E9%9D%A0%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/" title="如何给云计算用户提供安全可靠的操作系统镜像">如何给云计算用户提供安全可靠的操作系统镜像</a><time datetime="2024-12-04T06:36:24.000Z" title="发表于 2024-12-04 14:36:24">2024-12-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2013 - 2025 By 三木</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Pbdwq7jL0Ag8SyVhveiTbaTA-gzGzoHsz',
      appKey: '5z7cJ4LjydIGAt5kVlcKl6rG',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>