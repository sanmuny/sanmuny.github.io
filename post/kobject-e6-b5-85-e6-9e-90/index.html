<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="yes" name="apple-mobile-web-app-capable" />
  <meta content="black" name="apple-mobile-web-app-status-bar-style" />
  <meta name="referrer" content="never">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="kveln">
  <title>Kobject浅析 | 三木的技术博客</title>
  <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="https://sanmuny.github.io/media/css/bootstrap.min.css" rel="stylesheet"> -->
  <!--  <link href="https://sanmuny.github.io/media/css/all.min.css" rel="stylesheet" type="text/css"> -->
  <link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link rel="alternate" type="application/rss+xml" title="Kobject浅析 | 三木的技术博客 » Feed" href="https://sanmuny.github.io/atom.xml">
  <link rel="stylesheet"href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
  <link href="https://sanmuny.github.io/styles/main.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/highlight.min.js"></script>
  <!-- <script src="https://sanmuny.github.io/media/scripts/jquery.min.js"></script> -->
  <script>hljs.initHighlightingOnLoad();</script>
  

    <meta property="og:description" content="Kobject浅析"/>
    <meta property="og:url" content="https://sanmuny.github.io/post/kobject-e6-b5-85-e6-9e-90/"/>
    <meta property="og:locale" content="zh-CN"/>
    <meta property="og:type" content="website"/>
    <meta property="og:site_name" content="三木的技术博客"/>
  </head>
  <body>
  	<!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://sanmuny.github.io">三木的技术博客</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
          <li class="nav-item">
              
              <a class="nav-link" href="/">首页</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/archives">归档</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/post/about">关于</a>
              
          </li>
          
        </ul>
      </div>
    </div>
  </nav>
  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://sanmuny.github.io/media/images/home-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
          	<span class="tags">
          	 
            <a href="https://sanmuny.github.io/tag/zDJ2V3BHKNn/" class="tag">kobject</a>
            
        </span>
            <h1>Kobject浅析</h1>
            <span class="meta">
            	Posted on
              2014-04-24，8 min read
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <p>面向对象的思想的确在应用软件的开发中颇具优势，它让一个个纯逻辑的函数和数据变成了一个个有生命的个体。鉴于性能的考虑，系统软件的实现（例如linux kernel）并没有采用面向对象的语言（如C++、Java）。但这丝毫没有影响到用小c找对象。</p>
<p>简单来说，一个对象包含数据以及对这些数据的操作。如果把银行比作一个对象的话，银行里的RMB就是数据、而银行的工作人员就相当于对象中方法（即操作数据的结构）。如果，我们想打劫银行的话，我们只需要拿着枪指着工作人员说，“亲，给我拿500万出来”。当然，如果你是一个比较牛逼的劫匪你可能要1000万，或者更多。这没有关系，因为无论你要多少钱，你都不必亲自动手去取，工作人员会帮你办好这一切。当你拎着一袋子钱溜走的时候，你可能会想说，“自从有了面向对象，腰不酸了、腿不疼了，打劫也更有效率了”。</p>
<p>这个例子只是想说明面向对象的一个显而易见的优点——给劫匪，哦不，给用户提供了可直接使用的接口。当然，面向对象的优点可不只这一点。</p>
<p>kobject是Linux设备驱动模型的核心部分，它的作用是简单点说就是嵌入到设备和驱动相关的结构体之中。既可以将这些设备和驱动组织成树形结构，又可以让用户通过sysfs直接控制驱动和设备。让我们来搭讪一下kobject，从她那儿看看有对象的好处。</p>
<p>我们哲学老师在提问一个学生之前都会先问学生的家乡在哪儿。据他的逻辑应该是一方水土养一方人，从一个人的家乡可以大致推断出他的性格等。 不管这个理论对不对，我们先看看kobject的家乡——include/linux/kobject.h，kobject在这里定义：</p>
<pre><code>    struct kobject {
        const char *name;
        struct list_head entry;
        struct kobject *parent;
        struct kset *kset;
        struct kobj_type *ktype;
        struct sysfs_dirent *sd;
        struct kref kref;
        unsigned int state_initialized:1;
        unsigned int state_in_sysfs:1;
        unsigned int state_add_uevent_sent:1;
        unsigned int state_remove_uevent_sent:1;
        unsigned int uevent_suppress:1;
    };
</code></pre>
<p>每一个kobject实例都有一个名字name，用于标识这个实例。还有一个母亲parent，用于建立kobject的家族树。还有一个比较熟悉的面孔struct list_head entry，不用说，它的作用是把我们的kobject组织成双向链表。sd这个成员的作用和sysfs相关，kobject是组成sysfs树形结构的结点。kref是该结构体的引用计数，实质是一个原子型的整形量。下面几个unsigned int型的表示kobject的状态，kobject过得好还是不好，是不是党员，都在这里记录着。每一个kobject的结构体都有一个ktype，用来决定kobject被创建或销毁时应该如何处理：</p>
<pre><code>    struct kobj_type {
        void (*release)(struct kobject *kobj);
        const struct sysfs_ops *sysfs_ops;
        struct attribute **default_attrs;
        const struct kobj_ns_type_operations *(*child_ns_type)(struct kobject *kobj);
        const void *(*namespace)(struct kobject *kobj);
    };
</code></pre>
<p>release是个回调函数，当kobject的引用计数为0时会被调用。当然，这个函数是需要我们自己完成的。其作用通常是释放kobject守护的结构体。每一类kobject都有自己的默认的属性，它放在结构体数组default_attrs中。每一个属性都应该在sysfs中对应一个文件。而sysfs_ops则存放着读写这些文件时的处理。</p>
<p>每一个kobject都可以属于某一个kset，一个kset就是一群kobject的集合。当然，物以类聚，人以群分，这些kobject要走到一起，当然是要有些共同特点的：</p>
<pre><code>    struct kset {
        struct list_head list;
        spinlock_t list_lock;
        struct kobject kobj;
        const struct kset_uevent_ops *uevent_ops;
    };
</code></pre>
<p>kset是kobject的容器，也就是说，它把kobject又封装了一下。没一个kset结构体里面存放一个kobject，kset通过list连接起来，从而属于这一集合的所有kobj也连接起来了。uevent_ops这个结构体存放了对这一组object的操作。具体什么操作，咱下回分解。</p>
<p>kobject就好比每个人的守护天使，她通常不单独存在，而是作为其他结构体的成员出现，类似于struct list_head。在一个结构体中，找到嵌入于其中的kobject是很easy的事，就像领导找下属，随叫随到的那种。但是kobject要找到嵌入它的结构体的指针却没那么容易了。幸好，kernel给我们提供了一个可以做这件事的宏：</p>
<pre><code>contarner_of(pointer, type, member)
</code></pre>
<p>这个宏具体怎么用咱就不说了。google上百度一下，或者看下源码很容易就明白的。</p>
<p>有了这个宏，kobject守护的对象（设备和驱动）和kobject之间的联系就完全的建立起来了，kobject它妈叫它回家吃饭的时候就可以先找到设备和驱动，kobject要去打酱油的时候也可以叫上设备和驱动。</p>
<p>有了这个联系，系统里所有的设备和驱动就可以通过kobject给管理起来了。kobject和sysfs勾搭在一起就给用户层提供了修改设备和驱动参数的一种方式。</p>
<p>以下代码展示了如何利用kobject使用sysfs。</p>
<pre><code>    /**
     * This is a simple module for kobject test.And it is licensed under the terms
     * of GNU/GPL v3 or later.
     * Wang Sen (C) &lt;wangsen@linux.vnet.ibm.com&gt;
     * 2012.3.23
     */
    #include &lt;linux/module.h&gt;
    #include &lt;linux/init.h&gt;
    #include &lt;linux/kobject.h&gt;
    #include &lt;linux/sysfs.h&gt;
    #include &lt;linux/list.h&gt;
    #include &lt;linux/stat.h&gt;
    #include &lt;linux/string.h&gt;
    
    #define BUF_SIZE 128
    
    MODULE_LICENSE(&quot;GPL&quot;);
    
    static char asset[BUF_SIZE] = &quot;Hello Kitty&quot;;
    
    static void test_release(struct kobject *kobj);
    static ssize_t test_show(struct kobject *, struct attribute *, char *);
    static ssize_t test_store(struct kobject *, struct attribute *, const char *, size_t);
    
    static void test_release(struct kobject *kobj)
    {
    	if (kobj == NULL) {
    		return;
    	}
    	
    	printk(&quot;------[kobject_test]Hello,test_release is dancing\n&quot;);
    }
    
    static ssize_t test_show(struct kobject *kobj, struct attribute *attr, char *buf) 
    {
    	sprintf(buf, &quot;asset:%s\nkobject_name:%s\n&quot;, asset,kobj-&gt;name);
    	return strlen(buf);
    }
    
    static ssize_t test_store(struct kobject *kobj, struct attribute *attr, const char *buf, size_t size) 
    {
    	if (strlen(buf) &gt; BUF_SIZE) {
    		return E2BIG;
    	}
    	memset(asset, 0, BUF_SIZE);
    	sprintf(asset, &quot;%s&quot;, buf);
    	return strlen(buf);
    }
    
    struct attribute test_attr = {
    	.name = &quot;info&quot;,
    	.mode = S_IRWXUGO,
    }; 
    
    struct attribute test_attr_1 = {
    	.name = &quot;addr&quot;,
    	.mode = S_IRWXUGO,
    }; 
    
    struct attribute *attr_array[] = {
    	&amp;test_attr,
    	&amp;test_attr_1,
    	NULL
    };
    
    struct sysfs_ops test_sysfs_ops = {
    	.show = test_show,
    	.store = test_store,
    };
    
    struct kobject test_kobject;
    struct kobj_type test_kobj_type= {
    	.release = test_release,
    	.sysfs_ops = &amp;test_sysfs_ops,
    	.default_attrs = attr_array,
    };
    
    static int __init kobj_test_init(void)
    {
    	printk(&quot;------kobject init...&quot;);
    	kobject_init_and_add(&amp;test_kobject, &amp;test_kobj_type, NULL, &quot;test_object_of_kelvin&quot;);
    	return 0;
    }
    
    static void __exit kobj_test_exit(void)
    {
    	kobject_put(&amp;test_kobject);
    	printk(&quot;------See you&quot;);
    }
    
    module_init(kobj_test_init);
    module_exit(kobj_test_exit);
    
    MODULE_AUTHOR(&quot;Wang Sen &lt;senwang@linux.vnet.ibm.com&gt;&quot;);
</code></pre>
<p>参考文献：</p>
<ul>
<li>《LINUX设备驱动程序》 第三版 Jonathan Corbet,Alessandro Rubini,Greg Kroah-hartman</li>
<li><a href="http://linux.chinaunix.net/techdoc/system/2008/07/19/1018480.shtml">http://linux.chinaunix.net/techdoc/system/2008/07/19/1018480.shtml</a></li>
<li><a href="http://blog.21ic.com/user1/5593/archives/2010/69112.html">http://blog.21ic.com/user1/5593/archives/2010/69112.html</a></li>
<li><a href="http://blog.csdn.net/yili_xie/article/details/5835935">http://blog.csdn.net/yili_xie/article/details/5835935</a></li>
</ul>

          
          <p class="next-post">下一篇：
            <a href="https://sanmuny.github.io/post/e4-b8-ba-e8-99-9a-e6-8b-9f-e6-9c-bavcpu-e7-bb-91-e5-ae-9a-e7-89-a9-e7-90-86cpu/">
              <span class="post-title">
                为虚拟机vCPU绑定物理CPU&rarr;
              </span>
            </a>
          </p>
        
        <div class="comment">
          
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script>
  var gitalk = new Gitalk({
    clientID: '2876d946eb87c573ec4e',
    clientSecret: '909799984d0e9eb3525ac5c3604e6b5fee270ccd',
    repo: 'sanmuny.github.io',
    owner: 'sanmuny',
    admin: ['sanmuny'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container')
</script>

          
          
        
        </div>
      </div>
    </div>
  </article>
 <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/sanmuny" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
            <li class="list-inline-item">
              <a href="https://weibo.com/kelvinxupt" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
            
              
              <li class="list-inline-item">
              <a href="https://sanmuny.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li>
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>三木的技术博客</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://sanmuny.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://sanmuny.github.io/media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  </body>
</html>

